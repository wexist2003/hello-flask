<!doctype html>
<html lang="ru" data-bs-theme="light">

{# === Макросы (скопировано из user.html или предыдущего ответа) === #}
{% macro render_game_board_cell(cell_data, get_user_name_func_local) %} {# Изменено имя аргумента во избежание конфликта #}
<div class="game-board-spot-container m-1 text-center">
    <div class="game-board-pictogram"
         title="Клетка #{{ cell_data.cell_number }}"
         style="background-image: url('{{ url_for('static', filename=cell_data.image_path) }}');">
        <div class="game-board-cell-number">
            {{ cell_data.cell_number }}
        </div>
    </div>
    <div class="game-board-player-names-area">
        {% if cell_data.users_in_cell %}
            {% for player in cell_data.users_in_cell %}
                {# Предполагается, что get_user_name_func_local это ваша функция get_user_name #}
                {# И что player содержит 'id', 'name', 'rating' #}
                <span class="player-avatar-on-board" title="{{ player.name }} (Рейтинг: {{ player.rating }})">
                    {{ player.name[0]|upper if player.name and player.name|trim else '?' }}
                </span>{%- if not loop.last %}<span class="avatar-separator">, </span>{% endif -%}
            {% endfor %}
        {% else %}
            <div class="player-name-on-board-empty">&nbsp;</div>
        {% endif %}
    </div>
</div>
{% endmacro %}
{# === Конец Макросов === #}

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Админ-панель</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <style>
        body { padding-top: 1rem; padding-bottom: 1rem; }
        .container { max-width: 1140px; }
        
        .settings-block, .images-block, .game-board-block {
            margin-bottom: 2rem;
            padding: 1.5rem;
            border: 1px solid var(--bs-border-color);
            border-radius: 0.375rem;
            background-color: var(--bs-body-bg);
        }

        .theme-toggle-button {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 1050;
        }
        .image-preview-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        .image-preview-item {
            border: 1px solid var(--bs-border-color);
            padding: 5px;
            text-align: center;
            background-color: var(--bs-tertiary-bg);
        }
        .image-preview-item img {
            max-width: 100px;
            max-height: 100px;
            display: block;
            margin-bottom: 5px;
        }

        /* --- СТИЛИ ДЛЯ ИГРОВОГО ПОЛЯ (адаптировано из user.html) --- */
        .game-board-container { 
            display: flex; 
            flex-wrap: wrap; 
            gap: 4px; 
            padding: 0.5rem;
            justify-content: center; 
            background-color: var(--bs-tertiary-bg); 
            border-radius: .25rem; 
            min-height: 100px;
        }
        .game-board-spot-container { display: flex; flex-direction: column; align-items: center; flex-shrink: 0; margin: 2px; }
        .game-board-pictogram { 
            width: 60px; 
            height: 60px; 
            position: relative; 
            background-size: contain; 
            background-position: center; 
            background-repeat: no-repeat; 
            border: 1px solid var(--bs-border-color); 
            border-radius: .2rem; 
            margin-bottom: 3px; 
        }
        .game-board-cell-number { 
            position: absolute; 
            top: 0px; 
            left: 0px; 
            background-color: rgba(var(--bs-body-bg-rgb),0.9); 
            color: var(--bs-body-color); 
            padding: 1px 3px; 
            border-radius: 0.15rem 0 0.15rem 0; 
            font-size: 0.65em; 
            font-weight: bold; 
            border-right: 1px solid rgba(var(--bs-emphasis-color-rgb),0.1); 
            border-bottom: 1px solid rgba(var(--bs-emphasis-color-rgb),0.1); 
            line-height: 1.2; 
        }
        .game-board-player-names-area { 
            width: 60px; 
            line-height: 1.1; 
            max-height: 4.5em; 
            min-height: 1.5em; 
            overflow-y: auto; 
            text-align: center; 
            margin-top: 1px; 
            padding: 0; 
            display: flex; 
            flex-wrap: wrap; 
            justify-content: center; 
            align-items: center; 
            gap: 2px; 
        }
        .player-avatar-on-board { 
            display: inline-flex; 
            width: 1.5em; 
            height: 1.5em;
            border-radius: 50%; 
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1em; 
            overflow: hidden;
            vertical-align: middle; 
            line-height: 1; 
            color: var(--bs-light-text-emphasis); 
            background-color: var(--bs-secondary); 
        }
        html[data-bs-theme="dark"] .player-avatar-on-board {
             color: var(--bs-dark-text-emphasis);
             background-color: var(--bs-secondary);
        }
        .avatar-separator { 
            font-size: 0.9em; 
            padding: 0 1px; 
            vertical-align: middle; 
            line-height: 1;
            color: var(--bs-secondary-color);
        }
        .player-name-on-board-empty { 
            height: 1.5em; 
            line-height: 1.5em;
            width: 100%; 
            font-size: 1em; 
        }

        @media (max-width: 992px) {
            .game-board-pictogram { width: 50px; height: 50px; }
            .game-board-player-names-area { width: 50px; }
            .player-avatar-on-board { font-size: 0.9em; width: 1.4em; height: 1.4em;}
        }
        @media (max-width: 768px) {
            .game-board-pictogram { width: 42px; height: 42px; }
            .game-board-player-names-area { width: 42px; }
            .player-avatar-on-board { font-size: 0.8em; width: 1.3em; height: 1.3em;}
            .game-board-cell-number { font-size: 0.55em; }
        }
        /* --- КОНЕЦ СТИЛЕЙ ДЛЯ ИГРОВОГО ПОЛЯ --- */
    </style>
</head>
<body>
    <div class="container">
        <button id="theme-toggle-btn" class="btn btn-outline-secondary btn-sm theme-toggle-button" title="Сменить тему">
            <i class="bi bi-circle-half"></i>
            <span id="theme-toggle-text" class="visually-hidden">Сменить тему</span>
        </button>

        <div class="py-3 text-center">
            <img class="d-block mx-auto mb-3" src="{{ url_for('static', filename='images/logo_transparent.png') }}" alt="Dixit Logo" width="72">
            <h2>Административная панель</h2>
        </div>

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <div class="settings-block">
            <h3>Настройки игры</h3>
            <form method="post" action="{{ url_for('admin') }}" class="mb-3">
                <div class="row g-3 align-items-end mb-3">
                    <div class="col-md-6">
                        <label for="active_subfolder" class="form-label">Активная колода карт:</label>
                        <select name="active_subfolder" id="active_subfolder" class="form-select">
                            {% for folder in subfolders %}
                                <option value="{{ folder }}" {% if folder == active_subfolder %}selected{% endif %}>{{ folder }}</option>
                            {% endfor %}
                            {% if not subfolders %}
                                <option value="" disabled>Нет доступных колод</option>
                            {% endif %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <button type="submit" name="set_active_subfolder" value="1" class="btn btn-primary w-100">Установить активной</button>
                    </div>
                     <div class="col-md-3">
                        <button type="submit" name="toggle_show_card_info" value="1" class="btn btn-info w-100">
                            {{ "Скрыть инфо о картах" if show_card_info else "Показать инфо о картах" }}
                        </button>
                    </div>
                </div>
            </form>
             <hr>
            <form method="post" action="{{ url_for('admin') }}">
                 <div class="row g-3 align-items-end">
                    <div class="col-md-6">
                        <label for="num_cells_for_board_reset" class="form-label">Кол-во ячеек для поля (пусто = авто):</label>
                        <input type="number" class="form-control" name="num_cells_for_board_reset" id="num_cells_for_board_reset" placeholder="По умолчанию или по рейтингу">
                    </div>
                    <div class="col-md-6">
                         <button type="submit" name="reset_game_board_visuals" value="1" class="btn btn-warning w-100">Обновить/Сбросить поле</button>
                    </div>
                </div>
            </form>
            <p class="mt-2">Текущая активная колода: <strong>{{ active_subfolder or 'Не выбрана' }}</strong></p>
            <p>Показ информации о картах (для пользователей): <strong>{{ "Включен" if show_card_info else "Отключен" }}</strong></p>
            <p>Текущее количество ячеек на поле: <strong>{{ current_num_board_cells if current_num_board_cells > 0 else 'Не инициализировано' }}</strong></p>
        </div>

        {# === НОВЫЙ БЛОК: ИГРОВОЕ ПОЛЕ === #}
        <div class="game-board-block">
            <h3>Игровое поле</h3>
            <div class="game-board-container">
                {% if game_board and game_board|length > 0 %}
                    {% for cell_data in game_board %}
                        {{ render_game_board_cell(cell_data, get_user_name_func) }} {# Используем переданную функцию get_user_name #}
                    {% endfor %}
                {% else %}
                    <p class="text-muted w-100 text-center" style="padding: 1rem 0;">Игровое поле не загружено, пусто или не удалось инициализировать. Проверьте консоль Flask и настройки изображений поля.</p>
                {% endif %}
            </div>
        </div>
        {# === КОНЕЦ БЛОКА: ИГРОВОЕ ПОЛЕ === #}

        <div class="images-block">
            <h3>Список изображений в активной колоде ({{ active_subfolder or 'Нет' }})</h3>
            {% if images %}
                <div class="image-preview-container">
                    {% for image_row in images %}
                        <div class="image-preview-item">
                            <img src="{{ url_for('static', filename='images/' + image_row.subfolder + '/' + image_row.image) }}" alt="Карта {{ image_row.id }}">
                            <p class="mb-0"><small>ID: {{ image_row.id }}</small></p>
                            {% set owner_name = get_user_name_func(image_row.owner_id) %}
                            <p class="mb-0"><small>Владелец: {{ owner_name or ('ID ' + image_row.owner_id|string if image_row.owner_id else 'Нет') }}</small></p>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <p>В этой колоде нет изображений или колода не выбрана.</p>
            {% endif %}
        </div>
        <hr>
        <div class="text-center mt-4 mb-3">
             <a href="{{ url_for('logout') }}" class="btn btn-danger">Выйти из Админ-панели</a>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    {# --- СКРИПТ ДЛЯ ПЕРЕКЛЮЧЕНИЯ ТЕМ (аналогично user.html, но с другим ключом localStorage) --- #}
    <script>
        (function() {
            // console.log('Admin Theme script initializing...');
            const themeToggleBtn = document.getElementById('theme-toggle-btn');
            const htmlElement = document.documentElement;
            const storageKey = 'adminThemePreferenceDxt'; // Уникальный ключ для темы админки

            const applyTheme = (theme) => {
                // console.log('Admin Applying theme:', theme);
                htmlElement.setAttribute('data-bs-theme', theme);
                if (themeToggleBtn) {
                   themeToggleBtn.setAttribute('title', theme === 'dark' ? 'Переключить на светлую тему' : 'Переключить на темную тему');
                }
            };

            const toggleTheme = () => {
                // console.log('Admin toggleTheme function called.');
                const currentTheme = htmlElement.getAttribute('data-bs-theme') || 'light';
                const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                // console.log(`Admin Switching theme from ${currentTheme} to ${newTheme}`);
                applyTheme(newTheme);
                localStorage.setItem(storageKey, newTheme);
            };

            if (themeToggleBtn) {
                // console.log('Admin Theme toggle button FOUND. Adding click listener.');
                themeToggleBtn.addEventListener('click', toggleTheme);
            } else {
                console.error('Admin Theme toggle button with id "theme-toggle-btn" NOT FOUND!');
            }

            try {
                const savedTheme = localStorage.getItem(storageKey);
                const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
                const defaultTheme = savedTheme || (prefersDark ? 'dark' : 'light');
                // console.log('Admin Initial theme to apply:', defaultTheme, '(saved:', savedTheme, 'prefersDark:', prefersDark, ')');
                applyTheme(defaultTheme);
            } catch (e) {
                console.error('Admin Error applying initial theme:', e);
                applyTheme('light'); 
            }
        })();
    </script>
</body>
</html>
