<!doctype html>
<html lang="ru">

<head>
    <meta charset="utf-8">
    <title>Админка</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* Стили для ячейки с предположениями */
        .guesses-cell {
            font-size: 0.85em;
            line-height: 1.4;
            max-width: 300px;
            word-wrap: break-word;
        }
    </style>
</head>

<body class="p-4">
    <h1>Админка</h1>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <h2>Добавить пользователя</h2>
    <form method="post" action="{{ url_for('admin') }}">
        <div class="row g-3 align-items-end mb-3"> <div class="col-auto">
                <label for="name" class="form-label">Имя:</label>
                <input type="text" id="name" name="name" class="form-control" required>
            </div>
             <div class="col-auto">
                <label for="num_cards" class="form-label">Кол-во карт:</label>
                <input type="number" id="num_cards" name="num_cards" class="form-control" value="3" min="1" required style="width: 80px;">
            </div>
             <div class="col-auto">
                 <button type="submit" class="btn btn-primary">Добавить</button>
            </div>
        </div>
    </form>
    <hr> <h2>Выбрать активную колоду</h2>
     <form method="post" action="{{ url_for('admin') }}">
        <div class="row g-3 align-items-center mb-3"> <div class="col-auto">
                 <label for="active_subfolder" class="form-label">Активная колода:</label>
             </div>
            <div class="col-auto">
                <select id="active_subfolder" name="active_subfolder" class="form-select" style="width: auto;">
                     <option value="">-- Не выбрана --</option>
                     {% for subfolder in subfolders %}
                        <option value="{{ subfolder }}" {% if active_subfolder == subfolder %}selected{% endif %}>{{ subfolder }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-auto">
                 <button type="submit" class="btn btn-secondary">Применить</button> </div>
        </div>
    </form>
    <hr> <h2>Список пользователей (Рейтинг)</h2>
    <table class="table table-bordered table-striped table-hover">
        <thead class="table-dark">
            <tr>
                <th>ID</th>
                <th>Имя</th>
                <th>Код доступа</th>
                <th>Ссылка</th>
                <th>Рейтинг</th>
                <th>Предположения</th> <th>Действия</th>
            </tr>
        </thead>
        <tbody>
            {% for user in users %}
                <tr>
                    <td>{{ user['id'] }}</td>
                    <td>{{ user['name'] }}</td>
                    <td><code>{{ user['code'] }}</code></td>
                    <td>
                        <a href="{{ request.host_url }}user/{{ user['code'] }}" target="_blank">{{ request.host_url }}user/{{ user['code'] }}</a>
                    </td>
                    <td><strong>{{ user['rating'] }}</strong></td>
                    <td class="guesses-cell">
                        {% set user_id = user['id'] %}
                        {% set has_guesses = false %}
                        {# Перебираем все картинки, по которым были угадывания #}
                        {% if all_guesses_processed %} {# Проверяем, что словарь вообще есть #}
                            {% for image_id, guesses_for_image in all_guesses_processed.items() %}
                                 {# Проверяем, делал ли ТЕКУЩИЙ пользователь угадывание для ЭТОЙ картинки #}
                                {% if user_id in guesses_for_image %}
                                    {% set guessed_user_id = guesses_for_image[user_id] %}
                                    {% set guessed_user_name = user_names.get(guessed_user_id, 'ID?') %}
                                    Карточка {{ image_id }}: {{ guessed_user_name }}<br>
                                    {% set has_guesses = true %}
                                {% endif %}
                            {% endfor %}
                        {% endif %}
                        {% if not has_guesses %}
                             <span class="text-muted">Нет</span>
                        {% endif %}
                    </td>
                    <td>
                        <form action="{{ url_for('delete_user', user_id=user['id']) }}" method="post" style="display: inline-block;">
                            <button class="btn btn-danger btn-sm" type="submit" onclick="return confirm('Вы уверены, что хотите удалить пользователя {{ user['name'] }}? Это действие необратимо!');">Удалить</button>
                        </form>
                    </td>
                </tr>
            {% else %}
                <tr>
                    <td colspan="7" class="text-center">Пользователи еще не добавлены.</td> </tr>
            {% endfor %}
        </tbody>
    </table>
    <hr> <h2>Открыть карточки и подсчитать очки</h2>
    <form action="{{ url_for('open_cards') }}" method="post" class="mb-3"> <button class="btn btn-success" type="submit">Подсчитать очки</button>
         <p class="small text-muted mt-1">Нажмите после того, как все игроки сделали ход и выложили карты.</p>
    </form>
    <hr> <h2>Список изображений</h2>
    <table class="table table-bordered table-sm">
         <thead class="table-light">
            <tr>
                <th>Подкаталог</th>
                <th>Изображение</th>
                <th>Статус</th>
                <th>Превью</th>
            </tr>
        </thead>
        <tbody>
             {# Используем переменную images, которая теперь содержит словари #}
            {% for image in images %}
                 <tr>
                    <td>{{ image.subfolder }}</td>
                    <td>{{ image.image }}</td>
                    <td>{{ image.display_status }}</td> {# Используем обработанный статус #}
                    <td>
                        <img src="{{ url_for('static', filename='images/' + image.subfolder + '/' + image.image) }}" alt="{{ image.image }}" style="max-height: 60px; max-width: 100px; width: auto;">
                    </td>
                </tr>
             {% else %}
                 <tr><td colspan="4" class="text-center">Нет изображений в базе данных.</td></tr>
            {% endfor %}
        </tbody>
    </table>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
