<!doctype html>
<html lang="ru" data-bs-theme="light"> {# Тема по умолчанию - светлая #}

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1"> {# Для адаптивности #}
    <title>Админка</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    {# Иконки Bootstrap (опционально) #}
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <style>
        /* Пользовательские стили */
        body { padding-bottom: 5rem; }
        h2 { margin-top: 2rem; border-bottom: 1px solid #ccc; padding-bottom: 0.5rem; }
        h3 { margin-top: 1rem; font-size: 1.25rem; } /* Для заголовков внутри колонок */
        table { margin-top: 1rem; }
        .action-forms form { display: inline-block; margin-right: 5px; } /* Кнопки действий в строку */

        /* Стили для темной темы */
        html[data-bs-theme="dark"] #new-game-form {
            background-color: var(--bs-gray-900) !important;
            color: var(--bs-light) !important;
            border-color: var(--bs-border-color-translucent) !important;
        }
        html[data-bs-theme="dark"] #new-game-form label {
             color: var(--bs-light) !important;
        }
        html[data-bs-theme="dark"] #new-game-form .form-text.text-muted {
             color: var(--bs-secondary-color) !important;
        }
        html[data-bs-theme="dark"] #image-list-table .badge.bg-secondary {
            background-color: var(--bs-gray-800) !important;
            color: var(--bs-light) !important;
        }
    </style>
</head>

<body class="p-4">
    <div class="container-fluid"> {# Используем контейнер #}
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h1>Админка</h1>
             {# --- Кнопка смены темы --- #}
             <div>
                 <button id="theme-toggle-btn" class="btn btn-outline-secondary btn-sm" title="Сменить тему">
                     <i class="bi bi-circle-half"></i>
                     <span id="theme-toggle-text" class="visually-hidden">Сменить тему</span>
                 </button>
             </div>
        </div>

        {# --- Flash-сообщения --- #}
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                  <div class="alert alert-{{ category or 'info' }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                  </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        {# --- ОБЪЕДИНЕННЫЙ БЛОК ФОРМ: ВЫБОР КОЛОДЫ И ДОБАВЛЕНИЕ ПОЛЬЗОВАТЕЛЯ --- #}
        <div class="row mb-4 g-4"> {# Строка с отступами между колонками (g-4) #}
            {# --- Левая колонка: Выбор колоды --- #}
            <div class="col-md-5">
                <h3>Выбор колоды</h3>
                <form method="post" action="{{ url_for('admin') }}">
                    <div class="mb-3">
                        <label for="active_subfolder" class="form-label">Активная колода:</label>
                        <select id="active_subfolder" name="active_subfolder" class="form-select">
                            <option value="">-- Не выбрана --</option>
                            {% for subfolder in subfolders %}
                                <option value="{{ subfolder }}" {% if active_subfolder == subfolder %}selected{% endif %}>{{ subfolder }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <button type="submit" class="btn btn-secondary">Сохранить колоду</button>
                </form>
            </div>

            {# --- Правая колонка: Добавить пользователя --- #}
            <div class="col-md-7">
                 <h3>Добавить пользователя</h3>
                 {# Вертикальное расположение #}
                 <form method="post" action="{{ url_for('admin') }}">
                    <div class="mb-3">
                         <label for="name" class="form-label">Имя:</label>
                         <input type="text" id="name" name="name" class="form-control form-control-sm" required>
                    </div>
                    <div class="mb-3">
                         <label for="num_cards" class="form-label">Кол-во карт:</label>
                         <input type="number" id="num_cards" name="num_cards" class="form-control form-control-sm" value="3" min="1" required style="max-width: 150px;">
                    </div>
                    <div>
                        <button type="submit" class="btn btn-primary btn-sm">
                             <i class="bi bi-person-plus-fill"></i> Добавить
                        </button>
                    </div>
                </form>
            </div>
        </div>
        {# --- КОНЕЦ ОБЪЕДИНЕННОГО БЛОКА ФОРМ --- #}


        {# --- Кнопки управления раундом --- #}
        <h2>Управление раундом</h2>
        <div class="mb-4 action-forms">
            <form action="{{ url_for('open_cards') }}" method="post" onsubmit="return confirm('Открыть карты и подсчитать очки? Текущий раунд завершится, следующий ведущий будет назначен.');">
                <button class="btn btn-success" type="submit" {% if g.game_over %}disabled title="Игра окончена"{% endif %}>
                    <i class="bi bi-check2-circle"></i> Открыть карты / Подсчитать очки
                </button>
            </form>
            <form action="{{ url_for('new_round') }}" method="post" onsubmit="return confirm('Начать новый раунд? Карты со стола и предположения будут сброшены, всем будут розданы новые карты.');">
                <button class="btn btn-warning" type="submit" {% if g.game_over %}disabled title="Игра окончена"{% endif %}>
                    <i class="bi bi-arrow-clockwise"></i> Начать новый раунд
                </button>
            </form>
        </div>

        {# --- Список пользователей --- #}
        <h2>Список пользователей</h2>
        <div class="table-responsive mb-4">
            <table class="table table-bordered table-striped table-hover table-sm" style="table-layout: fixed; width: 100%;">
                <thead class="table-light"> {# Класс table-light адаптируется к теме #}
                    <tr>
                        <th style="width: 3%;" class="text-center">ID</th>
                        <th style="width: 15%;">Имя / Статус</th>
                        <th style="width: 15%;">Ссылка</th>
                        <th style="width: 7%;">Рейтинг</th>
                        <th>Предположения игрока</th>
                        <th style="width: 10%;">Действия</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in users %}
                        <tr>
                            <td class="text-center">{{ user.id }}</td>
                            <td> {# Имя / Статус #}
                                {{ user.name }}
                                {% if leader_to_display is not none and user.id == leader_to_display %}
                                    <span class="badge bg-success ms-2" title="Ведущий этого (или только что завершенного) раунда"><i class="bi bi-star-fill"></i> Ведущий</span>
                                {% endif %}
                            </td>
                            <td style="max-width: 180px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;"> {# Ссылка #}
                                <a href="{{ url_for('user', code=user.code) }}" target="_blank" title="{{ url_for('user', code=user.code, _external=True) }}">{{ user.code }} <i class="bi bi-box-arrow-up-right"></i></a>
                            </td>
                            <td>{{ user.rating }}</td> {# Рейтинг #}
                            <td> {# Предположения игрока #}
                                {% set user_guess_count = guess_counts_by_user.get(user.id, 0) %}
                                {% if user_guess_count > 0 %}
                                    <div style="column-count: 3; column-gap: 10px; font-size: 0.8rem;">
                                    {% for image_id, guesses_for_image in all_guesses.items() %}
                                        {% if user.id|string in guesses_for_image %}
                                            {% set guessed_owner_id = guesses_for_image[user.id|string] %}
                                            {% set actual_owner_id = image_owners.get(image_id) %}
                                            <small style="display: block; margin-bottom: 2px; white-space: nowrap;">
                                              Карта {{ image_id }}: {{ get_user_name(guessed_owner_id) or ('ID ' + guessed_owner_id|string) }}
                                              {% if actual_owner_id is not none and guessed_owner_id == actual_owner_id %}
                                                  <i class="bi bi-check-circle-fill text-success ms-1" title="Верно"></i>
                                              {% elif actual_owner_id is not none %}
                                                  <i class="bi bi-x-circle-fill text-danger ms-1" title="Неверно"></i>
                                              {% endif %}
                                            </small>
                                        {% endif %}
                                    {% endfor %}
                                    </div>
                                {% endif %}
                            </td>
                            <td class="action-forms text-center"> {# Действия #}
                                <form action="{{ url_for('admin') }}" method="post" onsubmit="return confirm('Вы уверены, что хотите удалить пользователя {{ user.name }} (ID: {{ user.id }})? Это действие необратимо!');">
                                    <input type="hidden" name="delete_user_id" value="{{ user.id }}">
                                    <button class="btn btn-danger btn-sm" type="submit" title="Удалить пользователя {{ user.name }}">
                                        <i class="bi bi-trash"></i> <span class="visually-hidden">Удалить</span>
                                    </button>
                                </form>
                            </td>
                        </tr>
                    {% else %}
                        <tr>
                            <td colspan="6" class="text-center text-muted">Пользователи еще не добавлены.</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {# --- Конец Списка пользователей --- #}


        {# === БЛОК "НАЧАТЬ НОВУЮ ИГРУ" ПЕРЕМЕЩЕН СЮДА === #}
        <h2>Начать новую игру</h2>
        <form id="new-game-form" method="post" action="{{ url_for('start_new_game') }}" class="mb-4 border p-3 rounded bg-light" onsubmit="return confirm('Вы уверены, что хотите начать НОВУЮ ИГРУ? Все рейтинги будут сброшены, карты переразданы.');">
             <div class="row g-3 align-items-end">
                 <div class="col-md-5">
                    <label for="new_game_subfolder" class="form-label">Выберите колоду для новой игры:</label>
                    <select id="new_game_subfolder" name="new_game_subfolder" class="form-select" required>
                        <option value="" disabled {% if not active_subfolder %}selected{% endif %}>-- Выберите колоду --</option>
                        {% for subfolder in subfolders %}
                            <option value="{{ subfolder }}" {% if active_subfolder == subfolder %}selected{% endif %}>{{ subfolder }}</option>
                        {% endfor %}
                    </select>
                 </div>
                 <div class="col-md-3">
                     <label for="new_game_num_cards" class="form-label">Карт на игрока:</label>
                     <input type="number" id="new_game_num_cards" name="new_game_num_cards" class="form-control" value="3" min="1" required>
                 </div>
                  <div class="col-auto">
                     <button type="submit" class="btn btn-danger"><i class="bi bi-bootstrap-reboot"></i> Начать новую игру</button>
                 </div>
             </div>
             <small class="form-text text-muted mt-2 d-block">
                 Внимание: Это действие сбросит все текущие очки, состояние стола, угадывания и назначит нового ведущего. Пользователи останутся.
             </small>
        </form>
        {# === КОНЕЦ БЛОКА "НАЧАТЬ НОВУЮ ИГРУ" === #}


        {# --- Список изображений --- #}
        <h2>Список изображений ({{ images|length }} шт. / Свободно: {{ free_image_count }})</h2>
         <div class="table-responsive">
            <table id="image-list-table" class="table table-bordered table-sm">
                <thead class="table-light"> {# Класс table-light адаптируется к теме #}
                    <tr>
                         <th>ID</th>
                         <th>Колода</th>
                         <th>Файл</th>
                         <th>Статус</th>
                         <th>Превью</th>
                    </tr>
                </thead>
                <tbody>
                    {% for image in images %}
                        <tr class="{{ 'table-secondary' if image.subfolder != active_subfolder else '' }}">
                            <td>{{ image.id }}</td>
                            <td>{{ image.subfolder }}</td>
                            <td>{{ image.image }}</td>
                            <td> {# Статус #}
                                {% if image.status and image.status.startswith('Занято:') %}
                                    <span class="badge bg-secondary" title="Карта назначена игроку">Занято</span>
                                {% elif image.status == 'На столе' %}
                                     <span class="badge bg-info" title="Карта выложена на стол">На столе</span>
                                {% elif image.status == 'Свободно' %}
                                    {% if image.subfolder == active_subfolder %}
                                         <span class="badge bg-light text-dark">Свободно</span> {# Адаптируется к теме #}
                                    {% else %}
                                         <span class="badge bg-light text-muted" title="Карта в неактивной колоде">Свободно</span> {# Адаптируется к теме #}
                                    {% endif %}
                                {% else %}
                                    {{ image.status or 'N/A' }}
                                {% endif %}
                            </td>
                            <td> {# Превью #}
                                <img src="{{ url_for('static', filename='images/' + image.subfolder + '/' + image.image) }}"
                                     alt="{{ image.image }}" style="max-width: 60px; height: auto;" loading="lazy">
                            </td>
                        </tr>
                    {% else %}
                         <tr>
                             <td colspan="5" class="text-center text-muted">Изображения не найдены или не загружены.</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

    </div> {# Конец container-fluid #}

    {# --- JavaScript Bootstrap --- #}
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    {# --- Скрипт смены темы --- #}
    <script>
        (function() {
            const themeToggleBtn = document.getElementById('theme-toggle-btn');
            const htmlElement = document.documentElement;
            const storageKey = 'adminThemePreference'; // Ключ для админки

            const applyTheme = (theme) => {
                htmlElement.setAttribute('data-bs-theme', theme);
                if (themeToggleBtn) {
                   themeToggleBtn.setAttribute('title', theme === 'dark' ? 'Переключить на светлую тему' : 'Переключить на темную тему');
                }
            };

            const toggleTheme = () => {
                const currentTheme = htmlElement.getAttribute('data-bs-theme') || 'light';
                const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                applyTheme(newTheme);
                localStorage.setItem(storageKey, newTheme);
            };

            if (themeToggleBtn) {
                themeToggleBtn.addEventListener('click', toggleTheme);
            }

            const savedTheme = localStorage.getItem(storageKey);
            const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
            const defaultTheme = savedTheme || (prefersDark ? 'dark' : 'light');

            applyTheme(defaultTheme);
        })();
    </script>
</body>
</html>
