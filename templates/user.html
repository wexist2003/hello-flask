<!doctype html>
<html lang="ru"> {# Убрал дублирующийся doctype #}

<head>
    <meta charset="utf-8">
    <title>Профиль {{ name }}</title> {# Используем name #}
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* Минимальные стили */
        body { padding-bottom: 5rem; }
        h2 { margin-top: 2rem; }
    </style>
</head>

<body class="p-4">

    {# --- НАЧАЛО: Заголовок и кнопка смены темы --- #}
    <div class="d-flex justify-content-between align-items-center mb-3">
         <h1>Привет, {{ name }}!</h1> {# Используем name #}
         <div>
             <button id="theme-toggle-btn" class="btn btn-outline-secondary btn-sm">
                 <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-circle-half" viewBox="0 0 16 16">
                     <path d="M8 15A7 7 0 1 0 8 1v14zm0 1A8 8 0 1 1 8 0a8 8 0 0 1 0 16z"/>
                 </svg>
                 <span id="theme-toggle-text">Сменить тему</span>
             </button>
        </div>
    </div>
    {# --- КОНЕЦ: Заголовок и кнопка смены темы --- #}

    <p>Ваш рейтинг: <strong>{{ rating }}</strong></p> {# Используем rating #}

    <hr>

    <h2>Общий стол</h2>
    <div class="border p-3 mb-4">
        <div class="d-flex flex-wrap gap-3">
            {% if table_images %} {# Используем table_images #}
         
    {% for table_image in table_images %}
            <div class="border p-2">
                {# Используем g.show_card_info для проверки видимости #}
                {% if g.show_card_info %}
                    <p>Чья: {{ get_user_name(table_image.owner_id) }}
                    {# --- ИЗМЕНЕНИЕ: Проверяем g.leader_of_revealed_round --- #}
                    {% if g.leader_of_revealed_round is not none and g.leader_of_revealed_round == table_image.owner_id %}
                        <span class="badge bg-success">Ведущий</span>
                    {% endif %}
                     {# --- КОНЕЦ ИЗМЕНЕНИЯ --- #}
                    </p>
                    <p>Предположения:</p>
                
    <ul>
                        {% for guesser_id, guessed_user_id in table_image.guesses.items() %}
                            <li>
                                {{ get_user_name(guesser_id|int) }}: это от {{ get_user_name(guessed_user_id|int) }}
                            </li>
                        {% endfor %}
                    </ul>
                {% endif %}

        <img src="{{ url_for('static', filename='images/' + table_image.subfolder + '/' + table_image.image) }}"
                    alt="card" style="max-width: 150px;">

                {# Логика формы угадывания - остается как была, использует g.show_card_info, g.user_id и т.д. #}
                {% if table_image.owner_id != g.user_id and not g.show_card_info %}
                <form method="post" action="{{ url_for('guess_image', code=code, image_id=table_image.id) }}">
                    <select name="guessed_user_id" class="form-select form-select-sm">
                        <option value="">-- Выберите игрока --</option>
                        {% for user in all_users %} {# Используем all_users #}
                        {% if user[0] != g.user_id %}
                            <option value="{{ user[0] }}"
                                {% if table_image.guesses and g.user_id|string in table_image.guesses and table_image.guesses[g.user_id|string]|int == user[0] %}selected{% endif %}>
                                {{  user[1] }}
                            </option>
                        {% endif %}
                        {% endfor %}
                    </select>
                    <button type="submit" class="btn btn-primary btn-sm mt-2">
                        {% if table_image.guesses and g.user_id|string in table_image.guesses %}
                        Изменить
                        {% else %}
                        Угадать
                        {% endif %}
                    </button>
                </form>
                {% else %} {# Случаи, когда форма не показывается #}
                <p class="mt-2 mb-0"> {# Используем mb-0 для компактности #}
                    {% if table_image.owner_id == g.user_id %}
                    <small><i>Это ваша карточка.</i></small>
                    {# Показываем предположение, если карты открыты и это не наша карта #}
                    {% elif g.show_card_info %}
                        {% set user_already_guessed = False %}
                        {% set user_guess = '' %}
                        {% if table_image.guesses and g.user_id|string in table_image.guesses %}
                             {% set user_already_guessed = True %}
                             {% set user_guess = get_user_name(table_image.guesses[g.user_id|string]|int) %}
                        {% endif %}
                        {% if user_already_guessed %}
                           <small><i>Вы предположили: {{ user_guess }}</i></small>
                        {% else %}
                            <small><i>Голосование завершено</i></small> {# Или 'Вы не угадывали' #}
                        {% endif %}
                    {# Показываем сделанное предположение, если карты еще не открыты #}
                    {% elif table_image.guesses and g.user_id|string in table_image.guesses %}
                         <small><i>Ваше предположение: {{ get_user_name(table_image.guesses[g.user_id|string]|int) }}</i></small>
                    {% endif %}
                </p>
                {% endif %}
                {# Этот блок дублировал показ предположений, убираем его #}
                {# {% if table_image.owner_id != g.user_id %}
                <p> ... </p>
                {% endif %} #}
            </div>
            {% endfor %}
            {% else %}
            <p>На столе нет карточек.</p>
       
        {% endif %}
        </div>
    </div>

    {# Блок "Мои карточки" - Оставлен без изменений #}
    <h2>Мои карточки</h2>
    <div class="d-flex flex-wrap gap-3">
        {% for card in cards %} {# Используем cards #}
        <div class="border p-2">
            <img src="{{ url_for('static', filename='images/' + card.subfolder + '/' + card.image) }}" alt="card"
                style="max-width: 150px;">
            {% if not on_table %} {# Используем on_table #}
            <form method="post" action="{{ url_for('place_card', code=code, image_id=card.id) }}"> {# Используем code #}
                <button type="submit" class="btn btn-success btn-sm mt-2">Выложить на стол</button>
            </form>
            {% endif %}
        </div>
        {% else %} {# Добавил else для единообразия #}
         <p>У вас нет карт.</p>
        {% endfor %}
    </div>

    {# Подключение JS Bootstrap #}
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    {# --- НАЧАЛО: Скрипт для смены темы --- #}
    <script>
        (function() {
            const themeToggleBtn = document.getElementById('theme-toggle-btn');
            const themeToggleText = document.getElementById('theme-toggle-text');
            const htmlElement = document.documentElement;
            const storageKey = 'themePreferenceUser'; // Отдельный ключ

            const applyTheme = (theme) => {
                htmlElement.setAttribute('data-bs-theme', theme);
                 if (themeToggleText) {
                    if (theme === 'dark') {
                        themeToggleText.textContent = 'Светлая тема';
                    } else {
                        themeToggleText.textContent = 'Темная тема';
                    }
                }
            };

            const toggleTheme = () => {
                const currentTheme = htmlElement.getAttribute('data-bs-theme') || 'light';
                const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                applyTheme(newTheme);
                localStorage.setItem(storageKey, newTheme);
            };

            if (themeToggleBtn) {
                themeToggleBtn.addEventListener('click', toggleTheme);
            }

            const savedTheme = localStorage.getItem(storageKey);
            const defaultTheme = savedTheme || 'light';
            applyTheme(defaultTheme);
        })();
    </script>
    {# --- КОНЕЦ: Скрипт для смены темы --- #}

</body>
</html>
