<!doctype html>
<html lang="ru">

<head>
    <meta charset="utf-8">
    <title>Профиль {% if name %}{{ name }}{% else %}Пользователя{% endif %}</title> {# Используем name, если передан #}
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding-bottom: 5rem; }
        h2 { margin-top: 2rem; }
        .card-on-table, .my-card { min-width: 170px; text-align: center; }
    </style>
</head>

<body class="p-4">

    {# Заголовок и кнопка смены темы #}
    <div class="d-flex justify-content-between align-items-center mb-3">
         <h1>Привет, {% if name %}{{ name }}{% else %}Пользователь{% endif %}!</h1> {# Используем name #}
         <div>
             <button id="theme-toggle-btn" class="btn btn-outline-secondary btn-sm">
                 <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-circle-half" viewBox="0 0 16 16">
                     <path d="M8 15A7 7 0 1 0 8 1v14zm0 1A8 8 0 1 1 8 0a8 8 0 0 1 0 16z"/>
                 </svg>
                 <span id="theme-toggle-text">Сменить тему</span>
             </button>
        </div>
    </div>

    {# Отображение flash сообщений #}
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="alert alert-{{ category or 'info' }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <p>Ваш рейтинг: <strong>{% if rating is defined %}{{ rating }}{% else %}0{% endif %}</strong></p> {# Используем rating #}

    <hr>

    {# Общий стол #}
    <h2>Общий стол</h2>
    <div class="border p-3 mb-4">
        <div class="d-flex flex-wrap gap-3">
            {% if table_images %} {# Используем table_images #}
         
    {% for table_image in table_images %} {# table_image должен быть словарем или Row #}
            <div class="border p-2 card-on-table">
                {# Показываем инфо, если g.show_card_info == True #}
                {% if g.show_card_info %}
                    <p class="mb-1"><small>Чья: <span class="fw-bold">{{ get_user_name(table_image.owner_id) }}</span>
                    {# Показываем метку ведущего ЗАВЕРШЕННОГО раунда #}
                    {% if g.leader_of_revealed_round is not none and g.leader_of_revealed_round == table_image.owner_id %}
                        <span class="badge bg-success ms-1">Ведущий</span>
                    {% endif %}
                    </small></p>
                    <p class="mb-1"><small>Предположения:</small></p>
                    {% if table_image.guesses %}
                    <ul class="list-unstyled mb-1 text-start">
                        {% for guesser_id, guessed_user_id in table_image.guesses.items() %}
                            <li><small>
                                {{ get_user_name(guesser_id|int) }}: {{ get_user_name(guessed_user_id|int) }}
                            </small></li>
                        {% endfor %}
                    </ul>
                    {% else %}
                        <small class="text-muted"><i>Нет</i></small>
                    {% endif %}
                {% else %}
                     <small>Чья карта?</small>
                {% endif %}

                {# Изображение карты #}
        <img src="{{ url_for('static', filename='images/' + table_image.subfolder + '/' + table_image.image) }}"
                    alt="card" style="max-width: 150px; display: block; margin-bottom: 10px; margin-left: auto; margin-right: auto;">

                {# Форма угадывания или статус (используем g) #}
                {% if g.user and table_image.owner_id != g.user.id %} {# Проверяем g.user и что карта не своя #}
                    {# Проверяем, угадывал ли уже #}
                    {% set user_already_guessed = False %}
                    {% set user_guess = '' %}
                    {% if table_image.guesses and g.user.id|string in table_image.guesses %}
                        {% set user_already_guessed = True %}
                        {% set user_guess = get_user_name(table_image.guesses[g.user.id|string]|int) %}
                    {% endif %}

                    {# Логика отображения формы или статуса #}
                    {% if not g.show_card_info and not user_already_guessed %} {# Показываем форму, если раунд идет и не угадывал #}
                    <form method="post" action="{{ url_for('guess_card', code=code, image_id=table_image.id) }}"> {# Используем guess_card и code #}
                        <select name="guessed_user_id" class="form-select form-select-sm" required>
                            <option value="" disabled selected>-- Выберите --</option>
                            {% for user_option in all_users %} {# Используем all_users #}
                                {# user_option - это Row или кортеж #}
                                {% if user_option[0] != g.user.id %}
                                    <option value="{{ user_option[0] }}">
                                        {{ user_option[1] }} {# Имя пользователя #}
                                    </option>
                                {% endif %}
                            {% endfor %}
                        </select>
                        <button type="submit" class="btn btn-primary btn-sm mt-1">Предположить</button> {# Кнопка всегда "Предположить"? Или менять как было? #}
                    </form>
                    {% else %} {# Если раунд закончен ИЛИ пользователь уже угадывал #}
                        <p class="mt-2 mb-0">
                            {% if user_already_guessed %}
                                 <small><i>Вы предположили: {{ user_guess }}</i></small>
                            {% elif g.show_card_info %} {# Если не угадывал, но раунд закончен #}
                                <small><i>Голосование завершено</i></small>
                            {% endif %}
                        </p>
                    {% endif %}
                {% elif g.user and table_image.owner_id == g.user.id %} {# Если это своя карта #}
                    <p class="mt-2 mb-0"><small><i>Ваша карта</i></small></p>
                {% endif %}
            </div>
            {% endfor %}
            {% else %}
            <p>На столе нет карточек.</p>
        {% endif %}
        </div>
    </div>

    {# Мои карточки #}
    <h2>Мои карточки</h2>
    <div class="d-flex flex-wrap gap-3">
        {% if cards %} {# Используем cards #}
            {% for card in cards %} {# card должен быть словарем или Row #}
            <div class="border p-2 my-card">
                <img src="{{ url_for('static', filename='images/' + card.subfolder + '/' + card.image) }}" alt="card"
                    style="max-width: 150px; display: block; margin-bottom: 10px; margin-left: auto; margin-right: auto;">

                 {# Проверяем, выложена ли ЭТА карта на стол #}
                 {% set this_card_on_table = False %}
                 {% if table_images %}
                     {% for table_card in table_images %}
                         {% if table_card.id == card.id %}
                             {% set this_card_on_table = True %}
                         {% endif %}
                     {% endfor %}
                 {% endif %}

                 {# Логика для кнопки "Выложить на стол", используем g #}
                 {% if g.user %}
                     {% if not g.show_card_info and not this_card_on_table %}
                          {# Проверяем, выложил ли пользователь уже карту #}
                          {% set user_already_placed = False %}
                          {% if table_images %}
                              {% for table_card in table_images %}
                                  {% if table_card.owner_id == g.user.id %}
                                      {% set user_already_placed = True %}
                                  {% endif %}
                              {% endfor %}
                          {% endif %}

                          {% if not user_already_placed %}
                              {# Убедитесь, что route 'place_card' существует #}
                              <form method="post" action="{{ url_for('place_card', code=code, image_id=card.id) }}"> {# Используем code #}
                                  <button type="submit" class="btn btn-success btn-sm mt-2">Выложить на стол</button>
                              </form>
                          {% else %}
                               <small class="text-muted d-block mt-2"><i>Вы уже выложили карту</i></small>
                          {% endif %}

                     {% elif this_card_on_table %}
                          <small class="text-muted d-block mt-2"><i>Карта на столе</i></small>
                     {% elif g.show_card_info %}
                          <small class="text-muted d-block mt-2"><i>Раунд завершен</i></small>
                     {% endif %}
                 {% endif %} {# Конец if g.user #}
            </div>
            {% endfor %}
        {% else %}
            <p>У вас нет карт.</p>
        {% endif %}
    </div>

    {# Скрипты #}
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        (function() {
            const themeToggleBtn = document.getElementById('theme-toggle-btn');
            const themeToggleText = document.getElementById('theme-toggle-text');
            const htmlElement = document.documentElement;
            const storageKey = 'themePreferenceUser'; // Отдельный ключ

            const applyTheme = (theme) => {
                htmlElement.setAttribute('data-bs-theme', theme);
                 if (themeToggleText) {
                    if (theme === 'dark') {
                        themeToggleText.textContent = 'Светлая тема';
                    } else {
                        themeToggleText.textContent = 'Темная тема';
                    }
                }
            };

            const toggleTheme = () => {
                const currentTheme = htmlElement.getAttribute('data-bs-theme') || 'light';
                const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                applyTheme(newTheme);
                localStorage.setItem(storageKey, newTheme);
            };

            if (themeToggleBtn) {
                themeToggleBtn.addEventListener('click', toggleTheme);
            }

            const savedTheme = localStorage.getItem(storageKey);
            const defaultTheme = savedTheme || 'light';
            applyTheme(defaultTheme);
        })();
    </script>

</body>
</html>
