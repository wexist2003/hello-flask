<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Страница игрока - {{ user_data_for_init.name if user_data_for_init else 'Игрок' }}</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        /* ... существующие стили ... */
        .player-card {
            border: 1px solid #ccc;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
            background-color: var(--card-bg-color);
            transition: border-color 0.3s ease-in-out;
        }
        .player-card.is-active {
            border-color: var(--my-card-highlight-color);
            box-shadow: 0 0 10px var(--my-card-highlight-shadow);
        }
        .player-card.is-leader {
            border-color: var(--leader-card-highlight-color);
            box-shadow: 0 0 10px var(--leader-card-highlight-shadow);
        }
        .player-card-image {
            width: 100%;
            height: auto;
            border-radius: 5px;
            margin-bottom: 10px;
            cursor: pointer; /* Делаем изображение кликабельным для модального окна */
        }
        .player-card-body h5 {
            color: var(--text-color);
        }
        .player-card-body p {
            color: var(--text-color-secondary);
        }
        .btn-game-action {
            width: 100%;
            margin-top: 5px;
        }
        .text-strike {
            text-decoration: line-through;
        }
        .game-board-image-container {
            border: 2px solid transparent; /* Изначально без рамки */
            transition: border-color 0.3s ease-in-out;
        }
        .game-board-image-container.active-guess {
            border-color: yellow; /* Желтая рамка для активного угадывания */
        }
        .game-board-image-container.guessed {
            border-color: green; /* Зеленая рамка для угаданного */
        }
        .game-board-image-container.placed {
            border-color: blue; /* Синяя рамка для размещенного */
        }
        .game-board-image-container.incorrect-guess {
            border-color: red; /* Красная рамка для неверного угадывания */
        }
        .image-container {
            position: relative;
            display: inline-block;
        }
        .image-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5); /* Темный фон */
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5em;
            font-weight: bold;
            opacity: 0; /* Скрыто по умолчанию */
            transition: opacity 0.3s ease;
            pointer-events: none; /* Чтобы не мешать кликам */
        }
        .image-container.dimmed .image-overlay {
            opacity: 1; /* Показываем при затемнении */
        }
        /* Стили для модального окна */
        .modal-body-image {
            max-width: 100%;
            height: auto;
            display: block;
            margin: auto;
        }
        .modal-xl {
            max-width: 90%;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1 class="mb-4">Страница игрока: <span id="current-user-name">{{ user_data_for_init.name if user_data_for_init else 'Загрузка...' }}</span></h1>
        <p>Ваш код игрока: <strong id="current-user-code">{{ user_data_for_init.code if user_data_for_init else 'Загрузка...' }}</strong></p>
        <p>Ваш рейтинг: <strong id="current-user-rating">{{ user_data_for_init.rating if user_data_for_init else 'Загрузка...' }}</strong></p>

        <div id="flash-messages">
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="alert alert-{{ category }}">{{ message }}</div>
                    {% endfor %}
                {% endif %}
            {% endwith %}
        </div>

        <div class="row">
            <div class="col-md-4">
                <h2>Игроки (<span id="active-users-count">0</span>)</h2>
                <div id="players-list">
                    {% if initial_game_state and initial_game_state.users %}
                        {% for user in initial_game_state.users %}
                            <div class="player-card {{ 'is-active' if user.code == user_data_for_init.code else '' }} {{ 'is-leader' if user.is_leader else '' }}" id="player-card-{{ user.code }}">
                                <div class="player-card-body">
                                    <h5 class="card-title">{{ user.name }} ({{ user.rating }})</h5>
                                    <p class="card-text">
                                        Статус: <span class="badge badge-{{ 'success' if user.status == 'active' else 'secondary' }}">{{ user.status }}</span>
                                        <br>
                                        На доске: <span class="badge badge-info">{{ user.current_position }}</span>
                                        <br>
                                        Последний бросок: <span class="badge badge-primary">{{ user.last_roll if user.last_roll is not none else 'N/A' }}</span>
                                        <br>
                                        Угаданные пользователи: <span class="badge badge-success">{{ user.guesses_made|length }}</span>
                                        <br>
                                        Размещено на доске: <span class="badge badge-success">{{ user.placements_made|length }}</span>
                                        <br>
                                        В игре: <span class="badge badge-{{ 'success' if user.is_in_game else 'secondary' }}">{{ 'Да' if user.is_in_game else 'Нет' }}</span>
                                    </p>
                                </div>
                            </div>
                        {% endfor %}
                    {% else %}
                        <p>Нет активных игроков.</p>
                    {% endif %}
                </div>
            </div>

            <div class="col-md-8">
                <h2>Игровое поле</h2>
                <div id="game-board" class="row">
                    {% if initial_game_state and initial_game_state.board_images %}
                        {% for img_data in initial_game_state.board_images %}
                            <div class="col-3 mb-3">
                                <div class="image-container {{ 'dimmed' if img_data.guessed_by or img_data.placed_by else '' }}">
                                    <img src="{{ url_for('static', filename='pole/' + img_data.filename) }}"
                                         class="img-fluid game-board-image player-card-image"
                                         alt="Изображение игрового поля {{ img_data.image_id }}"
                                         data-image-id="{{ img_data.image_id }}"
                                         data-toggle="modal" data-target="#imageModal">
                                    {% if img_data.guessed_by %}
                                        <div class="image-overlay guessed-overlay">
                                            Угадано: <span id="guessed-by-{{ img_data.image_id }}">{{ initial_game_state.users_by_code[img_data.guessed_by].name if initial_game_state.users_by_code[img_data.guessed_by] else 'Неизвестно' }}</span>
                                        </div>
                                    {% elif img_data.placed_by %}
                                        <div class="image-overlay placed-overlay">
                                            Размещено: <span id="placed-by-{{ img_data.image_id }}">{{ initial_game_state.users_by_code[img_data.placed_by].name if initial_game_state.users_by_code[img_data.placed_by] else 'Неизвестно' }}</span>
                                        </div>
                                    {% endif %}
                                </div>
                                <div class="mt-2 text-center">
                                    <p>Позиция: <strong>{{ img_data.board_position }}</strong></p>
                                    <div class="dropdown">
                                        <button class="btn btn-primary dropdown-toggle btn-game-action" type="button" id="guessDropdown-{{ img_data.image_id }}" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                            Угадать
                                        </button>
                                        <div class="dropdown-menu" aria-labelledby="guessDropdown-{{ img_data.image_id }}">
                                            {% if initial_game_state and initial_game_state.users %}
                                                {% for user_to_guess in initial_game_state.users %}
                                                    {% if user_to_guess.code != user_data_for_init.code and user_to_guess.status == 'active' %}
                                                        <a class="dropdown-item guess-action" href="#" data-image-id="{{ img_data.image_id }}" data-target-user-code="{{ user_to_guess.code }}">
                                                            {{ user_to_guess.name }}
                                                        </a>
                                                    {% endif %}
                                                {% endfor %}
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="dropdown mt-2">
                                        <button class="btn btn-secondary dropdown-toggle btn-game-action" type="button" id="placeDropdown-{{ img_data.image_id }}" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                            Разместить
                                        </button>
                                        <div class="dropdown-menu" aria-labelledby="placeDropdown-{{ img_data.image_id }}">
                                            {% if initial_game_state and initial_game_state.users %}
                                                {% for user_to_place in initial_game_state.users %}
                                                    {% if user_to_place.code == user_data_for_init.code and user_to_place.status == 'active' %}
                                                        <a class="dropdown-item place-action" href="#" data-image-id="{{ img_data.image_id }}" data-target-user-code="{{ user_to_place.code }}">
                                                            Разместить свою карточку
                                                        </a>
                                                    {% endif %}
                                                {% endfor %}
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    {% else %}
                        <p>Игровое поле не инициализировано.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="imageModalLabel">Просмотр изображения</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body text-center">
                    <img src="" class="modal-body-image" id="modalImage" alt="Увеличенное изображение">
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.0/socket.io.js"></script>

    <script>
        const socket = io();
        const userCode = "{{ user_data_for_init.code }}"; // Получаем код текущего пользователя из Jinja2

        // Функция для обновления состояния игрока на UI
        function updatePlayerUI(playerData) {
            const playerCard = document.getElementById(`player-card-${playerData.code}`);
            if (playerCard) {
                playerCard.querySelector('.card-title').innerText = `${playerData.name} (${playerData.rating})`;
                playerCard.querySelector('.badge-success').innerText = playerData.status;
                playerCard.querySelector('.badge-info').innerText = playerData.current_position;
                playerCard.querySelector('.badge-primary').innerText = playerData.last_roll !== null ? playerData.last_roll : 'N/A';
                playerCard.querySelector('.badge-success:nth-of-type(1)').innerText = playerData.guesses_made.length;
                playerCard.querySelector('.badge-success:nth-of-type(2)').innerText = playerData.placements_made.length;
                const inGameBadge = playerCard.querySelector('.badge-secondary'); // Find the badge for 'is_in_game'
                if (inGameBadge) {
                    inGameBadge.classList.remove('badge-success', 'badge-secondary');
                    inGameBadge.classList.add(playerData.is_in_game ? 'badge-success' : 'badge-secondary');
                    inGameBadge.innerText = playerData.is_in_game ? 'Да' : 'Нет';
                }

                // Обновление классов для текущего игрока и лидера
                if (playerData.code === userCode) {
                    playerCard.classList.add('is-active');
                } else {
                    playerCard.classList.remove('is-active');
                }
                if (playerData.is_leader) {
                    playerCard.classList.add('is-leader');
                } else {
                    playerCard.classList.remove('is-leader');
                }
            } else {
                // Если карточки игрока нет, создайте ее (это может произойти, если новый пользователь присоединился)
                const playersList = document.getElementById('players-list');
                const newPlayerCard = document.createElement('div');
                newPlayerCard.classList.add('player-card');
                if (playerData.code === userCode) {
                    newPlayerCard.classList.add('is-active');
                }
                if (playerData.is_leader) {
                    newPlayerCard.classList.add('is-leader');
                }
                newPlayerCard.id = `player-card-${playerData.code}`;
                newPlayerCard.innerHTML = `
                    <div class="player-card-body">
                        <h5 class="card-title">${playerData.name} (${playerData.rating})</h5>
                        <p class="card-text">
                            Статус: <span class="badge badge-${playerData.status === 'active' ? 'success' : 'secondary'}">${playerData.status}</span>
                            <br>
                            На доске: <span class="badge badge-info">${playerData.current_position}</span>
                            <br>
                            Последний бросок: <span class="badge badge-primary">${playerData.last_roll !== null ? playerData.last_roll : 'N/A'}</span>
                            <br>
                            Угаданные пользователи: <span class="badge badge-success">${playerData.guesses_made.length}</span>
                            <br>
                            Размещено на доске: <span class="badge badge-success">${playerData.placements_made.length}</span>
                            <br>
                            В игре: <span class="badge badge-${playerData.is_in_game ? 'success' : 'secondary'}">${playerData.is_in_game ? 'Да' : 'Нет'}</span>
                        </p>
                    </div>
                `;
                playersList.appendChild(newPlayerCard);
            }
        }

        // Функция для обновления состояния игрового поля на UI
        function updateGameBoardUI(boardData) {
            boardData.forEach(img_data => {
                const imageContainer = document.querySelector(`.image-container img[data-image-id="${img_data.image_id}"]`).closest('.image-container');
                if (imageContainer) {
                    imageContainer.classList.remove('dimmed'); // Сначала убираем все затемнения
                    let overlay = imageContainer.querySelector('.image-overlay');
                    if (overlay) {
                        overlay.remove(); // Удаляем существующие наложения
                    }

                    if (img_data.guessed_by) {
                        imageContainer.classList.add('dimmed');
                        overlay = document.createElement('div');
                        overlay.classList.add('image-overlay', 'guessed-overlay');
                        overlay.innerHTML = `Угадано: <span id="guessed-by-${img_data.image_id}">${img_data.guessed_by_name}</span>`;
                        imageContainer.appendChild(overlay);
                    } else if (img_data.placed_by) {
                        imageContainer.classList.add('dimmed');
                        overlay = document.createElement('div');
                        overlay.classList.add('image-overlay', 'placed-overlay');
                        overlay.innerHTML = `Размещено: <span id="placed-by-${img_data.image_id}">${img_data.placed_by_name}</span>`;
                        imageContainer.appendChild(overlay);
                    }
                }
            });
        }

        // Обработчик события 'game_update' от сервера
        socket.on('game_update', (data) => {
            console.log('Received game_update:', data);
            // Обновляем UI на основе полученных данных
            // Обновляем список игроков
            const playersList = document.getElementById('players-list');
            playersList.innerHTML = ''; // Очищаем текущий список
            const activeUsersCount = Object.keys(data.users).length;
            document.getElementById('active-users-count').innerText = activeUsersCount;

            // Сортируем пользователей по имени для стабильного порядка
            const sortedUsers = Object.values(data.users).sort((a, b) => a.name.localeCompare(b.name));

            sortedUsers.forEach(user => {
                updatePlayerUI(user);
            });

            // Обновляем игровое поле
            updateGameBoardUI(data.board_images);

            // Обновляем информацию о текущем пользователе (если она изменилась, например, рейтинг)
            if (data.users[userCode]) {
                const currentUserData = data.users[userCode];
                document.getElementById('current-user-name').innerText = currentUserData.name;
                document.getElementById('current-user-rating').innerText = currentUserData.rating;
            }

            // Отображение flash-сообщений
            const flashMessagesDiv = document.getElementById('flash-messages');
            flashMessagesDiv.innerHTML = ''; // Очищаем предыдущие сообщения
            if (data.flash_messages && data.flash_messages.length > 0) {
                data.flash_messages.forEach(msg => {
                    const alertDiv = document.createElement('div');
                    alertDiv.classList.add('alert', `alert-${msg.category}`);
                    alertDiv.innerText = msg.message;
                    flashMessagesDiv.appendChild(alertDiv);
                });
            }
        });

        // Обработчики кликов для кнопок "Угадать"
        $(document).on('click', '.guess-action', function(e) {
            e.preventDefault(); // Предотвращаем стандартное действие ссылки
            const imageId = $(this).data('image-id');
            const targetUserCode = $(this).data('target-user-code');
            console.log(`Guessing image ${imageId} for user ${targetUserCode}`);
            // Отправляем событие на сервер через SocketIO
            socket.emit('guess_action', { image_id: imageId, target_user_code: targetUserCode, user_code: userCode });
        });

        // Обработчики кликов для кнопок "Разместить"
        $(document).on('click', '.place-action', function(e) {
            e.preventDefault(); // Предотвращаем стандартное действие ссылки
            const imageId = $(this).data('image-id');
            const targetUserCode = $(this).data('target-user-code'); // В данном случае это будет userCode текущего пользователя
            console.log(`Placing image ${imageId} for user ${targetUserCode}`);
            // Отправляем событие на сервер через SocketIO
            socket.emit('place_action', { image_id: imageId, target_user_code: targetUserCode, user_code: userCode });
        });

        // Открытие модального окна с изображением
        $('.game-board-image').on('click', function() {
            var imageUrl = $(this).attr('src');
            $('#modalImage').attr('src', imageUrl);
            $('#imageModal').modal('show');
        });

        const themeToggleButton = document.getElementById('theme-toggle-icon-button');
        const iconMoon = document.getElementById('icon-moon');
        const iconSun = document.getElementById('icon-sun');

        function applyTheme(theme) {
            if (theme === 'dark') {
                document.body.classList.add('dark-theme');
                if (iconMoon) iconMoon.style.display = 'none';
                if (iconSun) iconSun.style.display = 'inline-block';
            } else {
                document.body.classList.remove('dark-theme');
                if (iconMoon) iconMoon.style.display = 'inline-block';
                if (iconSun) iconSun.style.display = 'none';
            }
        }

        let savedTheme = localStorage.getItem('theme');
        if (savedTheme) {
            applyTheme(savedTheme);
        } else {
            applyTheme('light');
        }

        if (themeToggleButton) {
            themeToggleButton.addEventListener('click', () => {
                let newTheme = document.body.classList.contains('dark-theme') ? 'light' : 'dark';
                localStorage.setItem('theme', newTheme);
                applyTheme(newTheme);
            });
        }

        const modalImageElement = document.getElementById('modalImage');
        if (modalImageElement) {
            modalImageElement.addEventListener('click', () => {
                $('#imageModal').modal('hide');
            });
        }
    </script>
</body>
</html>
