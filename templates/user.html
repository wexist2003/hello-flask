<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Страница игрока - {{ user_data_for_init.name if user_data_for_init else 'Игрок' }}</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        :root {
            --standard-font-size: 1.1rem;
            --standard-font-size-mobile: 1.1rem;
            --standard-font-size-mobile-small: 1rem;
            --flash-message-font-size: 1rem;
            --header-unified-font-size: 1.5rem;
            --header-unified-font-size-mobile: 1.3rem;

            --my-card-highlight-color: #28a745; /* Зеленый для своей карточки */
            --my-card-highlight-shadow: rgba(40, 167, 69, 0.5);

            /* --- ДОБАВЛЕНО: Переменные для синего цвета рамки Ведущего --- */
            --leader-card-highlight-color: #007bff; /* Синий для карточки Ведущего */
            --leader-card-highlight-shadow: rgba(0, 123, 255, 0.5);

            /* Переменные для темной темы */
            --background-color: #f8f9fa; /* Светлый фон */
            --text-color: #343a40; /* Темный текст */
            --card-background: #fff; /* Фон карточек */
            --header-background: #e9ecef; /* Фон шапки */
            --border-color: #dee2e6; /* Цвет границ */
            --shadow-color: rgba(0, 0, 0, 0.1); /* Цвет тени */
            --player-chip-color: #007bff;
            --player-chip-text-color: #fff;
        }

        body.dark-theme {
            --background-color: #343a40; /* Темный фон */
            --text-color: #f8f9fa; /* Светлый текст */
            --card-background: #495057; /* Темный фон карточек */
            --header-background: #212529; /* Темный фон шапки */
            --border-color: #6c757d; /* Темные границы */
            --shadow-color: rgba(255, 255, 255, 0.1); /* Светлая тень */
            --player-chip-color: #6610f2; /* Более яркий фиолетовый для чипов в темной теме */
            --player-chip-text-color: #fff;
        }

        body {
            background-color: var(--background-color);
            color: var(--text-color);
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .container {
            max-width: 1200px;
        }

        .page-header-custom {
            background-color: var(--header-background);
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        .theme-toggle-button {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-color);
        }

        #theme-toggle-icon-button svg {
            width: 1em;
            height: 1em;
            fill: currentColor;
        }

        .card-container {
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
            background-color: var(--card-background);
            box-shadow: 0 4px 8px var(--shadow-color);
            transition: background-color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
            position: relative;
            margin-bottom: 1rem;
            display: flex;
            flex-direction: column;
            align-items: center; /* Центрирование содержимого */
        }

        .card-image {
            width: 100%;
            height: auto;
            border-bottom: 1px solid var(--border-color);
            cursor: zoom-in;
        }

        .card-body {
            padding: 0.5rem;
            width: 100%;
        }

        .player-hand-card .card-image {
            height: 150px; /* Фиксированная высота для карточек в руке */
            object-fit: cover; /* Обрезка изображения для заполнения */
            object-position: center; /* Центрирование изображения */
        }

        .table-card .card-image {
            height: 200px; /* Фиксированная высота для карточек на столе */
            object-fit: cover;
            object-position: center;
        }

        .card-text-center {
            text-align: center;
            margin-top: 0.5rem;
            font-size: var(--standard-font-size);
        }

        .game-board {
            display: grid;
            gap: 5px;
            width: 100%;
            margin-top: 20px;
        }

        .board-cell {
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            aspect-ratio: 1 / 1; /* Сохраняет квадратную форму ячейки */
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            align-items: center;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            position: relative;
            padding: 5px; /* Немного отступа для содержимого */
            box-shadow: 0 2px 4px var(--shadow-color);
        }

        .cell-number-badge {
            position: absolute;
            top: 5px;
            left: 5px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .player-chip {
            background-color: var(--player-chip-color);
            color: var(--player-chip-text-color);
            padding: 2px 5px;
            border-radius: 10px;
            font-size: 0.75rem;
            margin-top: 3px;
            white-space: nowrap; /* Предотвратить перенос имени */
            overflow: hidden; /* Скрыть переполнение */
            text-overflow: ellipsis; /* Добавить многоточие */
            max-width: 90%; /* Ограничить ширину чипа */
        }

        .player-chip.current-user {
            background-color: var(--my-card-highlight-color); /* Зеленый для текущего пользователя */
        }

        .player-chip-list {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 2px;
            margin-top: auto; /* Прижимает чипы к низу ячейки */
        }

        /* Выделение своей карточки, когда она на столе и открыта */
        .my-owned-card-revealed {
            border: 3px solid var(--my-card-highlight-color) !important;
            box-shadow: 0 0 15px var(--my-card-highlight-shadow) !important;
        }

        /* Выделение карточки ведущего, когда она на столе и открыта */
        .leader-card-highlight {
            border: 3px solid var(--leader-card-highlight-color) !important;
            box-shadow: 0 0 15px var(--leader-card-highlight-shadow) !important;
        }

        /* Карточка, которая уже выложена */
        .placed-on-table {
            border: 2px solid var(--leader-card-highlight-color);
            box-shadow: 0 0 10px var(--leader-card-highlight-shadow);
        }

        .game-messages-box {
            min-height: 50px; /* Минимальная высота для сообщений */
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            margin-bottom: 1rem;
            font-size: var(--standard-font-size);
            font-weight: bold;
        }

        .rules-section h4 {
            margin-top: 1.5rem;
            margin-bottom: 1rem;
        }

        .rules-image {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin-bottom: 1rem;
            box-shadow: 0 4px 8px var(--shadow-color);
        }

        .rules-list {
            list-style-type: disc;
            margin-left: 20px;
        }

        .list-group-item {
            background-color: var(--card-background);
            color: var(--text-color);
            border-color: var(--border-color);
        }

        .guess-feedback {
            font-size: 0.9rem;
            margin-top: 5px;
            padding: 3px 0;
            text-align: center;
        }

        .guess-feedback-correct {
            color: #28a745; /* Bootstrap Success */
            font-weight: bold;
        }

        .guess-feedback-incorrect {
            color: #dc3545; /* Bootstrap Danger */
            font-weight: bold;
        }

        /* Стили для всплывающего модального окна */
        .modal-content {
            background-color: var(--card-background);
            color: var(--text-color);
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .modal-header, .modal-footer {
            border-bottom: 1px solid var(--border-color);
            border-top: 1px solid var(--border-color);
        }

        .close {
            color: var(--text-color);
        }

        .modal-body img {
            max-width: 100%;
            height: auto;
            display: block;
            margin: 0 auto;
            cursor: zoom-out;
        }

        .form-check-input {
            margin-top: 0.3em; /* Уменьшаем отступ, чтобы выровнять с текстом */
        }

        .form-check-label {
            margin-bottom: 0; /* Убираем нижний отступ */
        }

        /* Адаптивные стили для шрифтов */
        @media (max-width: 768px) {
            :root {
                --standard-font-size: var(--standard-font-size-mobile);
                --header-unified-font-size: var(--header-unified-font-size-mobile);
                --flash-message-font-size: 0.9rem;
            }

            .player-hand-card .card-image {
                height: 120px;
            }

            .table-card .card-image {
                height: 150px;
            }
        }

        @media (max-width: 576px) {
            :root {
                --standard-font-size: var(--standard-font-size-mobile-small);
                --flash-message-font-size: 0.85rem;
            }

            .player-hand-card .card-image {
                height: 100px;
            }

            .table-card .card-image {
                height: 120px;
            }

            .board-cell {
                padding: 3px;
            }

            .cell-number-badge {
                width: 20px;
                height: 20px;
                font-size: 0.7rem;
            }

            .player-chip {
                font-size: 0.65rem;
                padding: 1px 3px;
            }
        }
    </style>
</head>
<body>
    <div class="container-fluid page-header-custom">
        <div id="user-greeting-container">
            <span id="user-greeting-text" class="h4 mb-0">Привет, {{ user_data_for_init.name }}!</span>
            <span id="user-status-badge-container">
                <span class="badge badge-primary ml-2">{{ user_data_for_init.status_display }}</span>
            </span>
        </div>
        <div>
            {% if session.get('is_admin') %}
                <a href="{{ url_for('admin_panel') }}" class="btn btn-info mr-2">Админ-панель</a>
            {% endif %}
            <button id="theme-toggle-icon-button" class="theme-toggle-button" aria-label="Переключить тему">
                <svg id="icon-moon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-moon"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
                <svg id="icon-sun" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-sun"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
            </button>
            <a href="{{ url_for('logout') }}" class="btn btn-outline-danger ml-2">Выйти</a>
        </div>
    </div>

    <div class="container">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="row">
                    <div class="col-12">
                        {% for category, message in messages %}
                            <div class="alert alert-{{ category }} alert-dismissible fade show flash-message" role="alert">
                                <span style="font-size: var(--flash-message-font-size);">{{ message }}</span>
                                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            {% endif %}
        {% endwith %}

        <div class="row mb-3">
            <div class="col-md-6">
                <p class="h5">Ведущий: <span id="current-leader-display"></span></p>
            </div>
            <div class="col-md-6 text-md-right">
                <p class="h5" id="next-leader-container" style="display: none;">Следующий ведущий: <span id="next-leader-display"></span></p>
            </div>
        </div>

        <div class="game-messages-box mb-4" id="game-messages">
            </div>

        <div id="pending-player-message" class="alert alert-info text-center" style="display: none;">
            Подождите, пока ведущий начнет игру или выберет свою карточку.
        </div>

        <h3 class="mb-3 text-center">Игровой стол</h3>
        <div class="row" id="table-cards">
            <div id="table-placeholder" class="col-12 text-center my-5" style="display: none;">
                <p class="h5">Ожидание карточек на столе...</p>
            </div>
        </div>

        <h3 class="mt-5 mb-3 text-center" id="my-cards-header">Мои карточки</h3>
        <div class="row" id="player-hand-section">
            <div id="player-hand" class="row">
                <div id="player-hand-placeholder" class="col-12 text-center my-5" style="display: none;">
                    <p class="h5">Загрузка ваших карточек...</p>
                </div>
            </div>
        </div>

        <h3 class="mt-5 mb-3 text-center">Игровое поле</h3>
        <div id="game-board" class="game-board">
            </div>


        <h3 class="mt-5 mb-3 text-center">Правила игры</h3>
        <div class="row rules-section">
            <div class="col-md-6">
                <h4 class="text-center">Краткие правила</h4>
                <p>1. **Ведущий** выбирает карточку из своей руки и придумывает к ней ассоциацию (слово, фразу, предложение). Ассоциация должна быть достаточно общей, чтобы другие игроки могли к ней подобрать свои карточки, но не слишком очевидной.</p>
                <p>2. **Остальные игроки** выбирают из своих рук карточку, которая, по их мнению, лучше всего подходит к ассоциации ведущего, и кладут её рубашкой вверх.</p>
                <p>3. **Ведущий перемешивает** все выложенные карточки (свою и от других игроков) и выкладывает их на стол лицевой стороной вверх.</p>
                <p>4. **Все игроки (кроме ведущего)** голосуют за карточку, которая, по их мнению, принадлежит ведущему.</p>
                <p>5. **Подсчет очков:**
                    <ul>
                        <li>Если все или никто не угадали карточку ведущего, ведущий получает 0 очков, а все остальные игроки (кроме ведущего) получают по 2 очка.</li>
                        <li>Если хотя бы один игрок, но не все, угадал карточку ведущего, ведущий и все игроки, угадавшие его карточку, получают по 3 очка.</li>
                        <li>Игроки, чью карточку угадали (кроме ведущего), получают по 1 очку за каждый голос, но не более 3 очков.</li>
                    </ul>
                </p>
                <p>Игра продолжается до тех пор, пока у игроков не закончатся карточки или не будет достигнут заранее оговоренный лимит очков.</p>
                <p class="text-center"><a href="{{ url_for('vote_deck') }}" class="btn btn-outline-info mt-3">Проголосовать за колоду</a></p>
            </div>
            <div class="col-md-6 d-flex align-items-center justify-content-center">
                <img src="{{ url_for('static', filename='images/rules.webp') }}" alt="Правила игры" class="img-fluid rules-image">
            </div>
        </div>
    </div>

    <div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="imageModalLabel">Увеличенное изображение</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <img src="" id="modalImage" class="img-fluid" alt="Увеличенное изображение">
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
    <script>
        const currentUserCode = "{{ user_data_for_init.user_code }}";
        const currentUserId = "{{ user_data_for_init.id }}";
        const currentUserName = "{{ user_data_for_init.name }}";

        const socket = io();

        socket.on('connect', function() {
            console.log('Connected to server');
            // Опционально: Отправить user_code на сервер при подключении
            socket.emit('client_connected', {
                user_code: currentUserCode,
                user_id: currentUserId,
                user_name: currentUserName
            });
        });

        socket.on('disconnect', function() {
            console.log('Disconnected from server');
            // Можно добавить уведомление пользователю о потере соединения
        });

        socket.on('message', function(data) {
            const gameMessages = $('#game-messages');
            gameMessages.text(data.text);
            console.log('Server message:', data.text);
            // Optionally, clear message after some time
            // setTimeout(() => gameMessages.text(''), 5000);
        });

        socket.on('game_update', function(gameState) {
            console.log('Game state updated:', gameState);
            updatePage(gameState);
        });

        function updatePage(gameState) {
            // Update user greeting and status
            const userStatusBadge = $('#user-status-badge-container .badge');
            if (userStatusBadge.length) {
                userStatusBadge.text(gameState.user_status_display);
                userStatusBadge.removeClass('badge-primary badge-success badge-warning badge-info').addClass(`badge-${gameState.user_status_badge_class}`);
            }

            // Show/hide player hand based on user status
            const playerHandSection = $('#player-hand-section');
            const myCardsHeader = $('#my-cards-header');
            const pendingPlayerMessage = $('#pending-player-message');

            if (gameState.user_status_display === 'Активен') {
                playerHandSection.show();
                myCardsHeader.show();
                pendingPlayerMessage.hide();
            } else {
                playerHandSection.hide();
                myCardsHeader.hide();
                pendingPlayerMessage.show();
            }

            // Update current leader display
            const currentLeaderDisplay = $('#current-leader-display');
            if (gameState.current_leader_name) {
                let leaderText = gameState.current_leader_name;
                if (gameState.current_leader_id === currentUserId) {
                    leaderText += ' (Это вы!)';
                }
                currentLeaderDisplay.text(leaderText);
            } else {
                currentLeaderDisplay.text('Ожидание...');
            }

            // Update next leader display (show only when relevant)
            const nextLeaderContainer = $('#next-leader-container');
            const nextLeaderDisplay = $('#next-leader-display');
            if (gameState.show_card_info && gameState.next_leader_name) {
                nextLeaderDisplay.text(gameState.next_leader_name);
                nextLeaderContainer.show();
            } else {
                nextLeaderContainer.hide();
            }

            updatePlayerHand(gameState);
            updateTableCards(gameState);
            updateGameBoard(gameState.board_cells, gameState.total_board_cells);

            // Handle flashed messages received via game_update
            if (gameState.flashed_messages && gameState.flashed_messages.length > 0) {
                const flashedMessagesContainer = $('.container > .row:first-child');
                flashedMessagesContainer.empty(); // Clear existing flashed messages
                gameState.flashed_messages.forEach(msg => {
                    const alertHtml = `
                        <div class="col-12">
                            <div class="alert alert-${msg.category} alert-dismissible fade show flash-message" role="alert">
                                <span style="font-size: var(--flash-message-font-size);">${msg.message}</span>
                                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                            </div>
                        </div>
                    `;
                    flashedMessagesContainer.append(alertHtml);
                });
            }
        }


        function showImageModal(imageSrc) {
            $('#modalImage').attr('src', imageSrc);
            $('#imageModal').modal('show');
        }

        function updatePlayerHand(gameState) {
            const playerHand = $('#player-hand');
            playerHand.empty(); // Очищаем текущие карточки

            if (!gameState.player_hand || gameState.player_hand.length === 0) {
                $('#player-hand-placeholder').text('У вас нет карточек на руках.').show();
                return;
            } else {
                $('#player-hand-placeholder').hide();
            }

            gameState.player_hand.forEach(card => {
                let buttonHtml = '';
                let cardClass = '';
                let cardStatusText = '';

                if (card.placed_by_user) {
                    cardClass = 'placed-on-table';
                    cardStatusText = '(Эта карточка на столе)';
                } else if (gameState.can_place_card && gameState.current_leader_id === currentUserId) {
                    // Ведущий может выложить свою карту
                    buttonHtml = `
                        <form action="/user/${currentUserCode}/place/${card.id}" method="post" class="mt-2">
                            <button type="submit" class="btn btn-success btn-sm">Выложить</button>
                        </form>
                    `;
                }

                const cardHtml = `
                    <div class="col-6 col-md-4 col-lg-3 d-flex justify-content-center">
                        <div class="card-container player-hand-card ${cardClass}" style="width: 100%;">
                            <img src="${card.image_path}" class="card-image" alt="Карточка ${card.id}" onclick="showImageModal('${card.image_path}')">
                            <div class="card-body text-center">
                                ${cardStatusText ? `<p class="card-text-center mb-1"><small>${cardStatusText}</small></p>` : ''}
                                ${buttonHtml}
                            </div>
                        </div>
                    </div>
                `;
                playerHand.append(cardHtml);
            });
        }

        function updateTableCards(gameState) {
            const tableCardsContainer = $('#table-cards');
            tableCardsContainer.empty(); // Очищаем текущие карточки

            if (!gameState.table_cards || gameState.table_cards.length === 0) {
                const placeholder = $('#table-placeholder');
                if (gameState.current_leader_id === currentUserId && gameState.can_place_card) {
                    placeholder.html('<p class="h5">Время выбрать свою карточку и придумать ассоциацию!</p>');
                } else if (!gameState.can_place_card && gameState.current_leader_id === currentUserId) {
                    placeholder.html('<p class="h5">Ожидание карточек от других игроков...</p>');
                } else {
                    placeholder.html('<p class="h5">Ожидание карточки от ведущего и других игроков...</p>');
                }
                placeholder.show();
                return;
            } else {
                $('#table-placeholder').hide();
            }

            gameState.table_cards.forEach(card => {
                const imageSrc = gameState.show_card_info ? card.image_path : '/static/images/a.jpg'; // заглушка 'a.jpg'
                let ownerInfo = '';
                let guessFormHtml = '';
                let myGuessText = '';
                let guessesListHtml = '';
                let cardHighlightClass = '';

                // Add highlight for my owned card if revealed
                if (gameState.show_card_info && card.is_my_card) {
                    cardHighlightClass += ' my-owned-card-revealed';
                }
                // Add highlight for leader's card if revealed
                if (gameState.show_card_info && card.is_leader_card) {
                    cardHighlightClass += ' leader-card-highlight';
                }


                if (gameState.show_card_info) {
                    // Show owner info
                    ownerInfo = `<p class="card-text-center mb-1">Чья: <strong>${card.owner_name}</strong></p>`;

                    // Show guesses
                    if (card.guesses && card.guesses.length > 0) {
                        guessesListHtml = `<ul class="list-group list-group-flush list-group-item-actions" style="font-size: 0.9em; width: 100%;">`;
                        guessesListHtml += `<li class="list-group-item text-center">Предположения:</li>`;
                        card.guesses.forEach(guess => {
                            let guessClass = '';
                            if (guess.is_correct_guess) {
                                guessClass = 'guess-feedback-correct';
                            } else {
                                guessClass = 'guess-feedback-incorrect';
                            }

                            // Highlight my guess
                            let myGuessClass = '';
                            if (guess.guesser_id === currentUserId) {
                                myGuessClass = `list-group-item-${guess.is_correct_guess ? 'success' : 'danger'}`;
                            }

                            guessesListHtml += `
                                <li class="list-group-item d-flex justify-content-between align-items-center ${myGuessClass}">
                                    <span>${guess.guesser_name}</span>
                                    <span class="${guessClass}">${guess.is_correct_guess ? 'Верно' : 'Мимо'}</span>
                                </li>
                            `;
                        });
                        guessesListHtml += `</ul>`;
                    }
                } else {
                    // Guessing phase
                    if (gameState.all_cards_placed_for_guessing_phase_to_template && !card.my_guess_made && currentUserId !== gameState.current_leader_id) {
                        // Only show form if all cards are placed, I haven't guessed yet, and I'm not the leader
                        guessFormHtml = `
                            <form class="guess-form" data-card-id="${card.id}" data-user-code="${currentUserCode}">
                                <div class="form-group text-center mb-1">
                                    <p class="mb-1">Чья карточка?</p>
                                    ${gameState.guess_options.map(option => `
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="radio" name="guessed_owner_id" id="radio-${card.id}-${option.id}" value="${option.id}" required>
                                            <label class="form-check-label" for="radio-${card.id}-${option.id}">${option.name}</label>
                                        </div>
                                    `).join('')}
                                </div>
                                <button type="submit" class="btn btn-primary btn-sm btn-block">Угадать</button>
                            </form>
                        `;
                    } else if (card.my_guess_made) {
                        myGuessText = `<p class="card-text-center mb-1"><small>Мой выбор: <strong>${card.my_guessed_owner_name}</strong></small></p>`;
                    }
                }

                const cardHtml = `
                    <div class="col-6 col-md-4 col-lg-3 d-flex justify-content-center mb-4">
                        <div class="card-container table-card ${cardHighlightClass}" style="width: 100%;">
                            <img src="${imageSrc}" class="card-image" alt="Карточка ${card.id}" onclick="showImageModal('${imageSrc}')">
                            <div class="card-body">
                                ${ownerInfo}
                                ${myGuessText}
                                ${guessFormHtml}
                                ${guessesListHtml}
                            </div>
                        </div>
                    </div>
                `;
                tableCardsContainer.append(cardHtml);
            });

            // Re-attach event listeners for newly added forms
            attachGuessFormListeners();
        }

        function updateGameBoard(boardCells, totalCells) {
            const gameBoard = $('#game-board');
            gameBoard.empty(); // Clear existing board

            if (!boardCells || totalCells === 0) {
                gameBoard.html('<p class="h5 text-center mt-5">Игровое поле не инициализировано.</p>');
                return;
            }

            let numColumns;
            const screenWidth = $(window).width();

            if (screenWidth >= 992) { // Large devices
                numColumns = 8;
            } else if (screenWidth >= 768) { // Medium devices
                numColumns = 6;
            } else if (screenWidth >= 576) { // Small devices
                numColumns = 5;
            } else { // Extra small devices
                numColumns = 4;
            }

            gameBoard.css('grid-template-columns', `repeat(${numColumns}, 1fr)`);

            boardCells.forEach((cell, index) => {
                const cellNumber = index + 1; // Cell numbers are 1-based
                const playersOnCell = cell.players_on_cell || []; // Ensure it's an array

                let playerChipsHtml = '';
                if (playersOnCell.length > 0) {
                    playerChipsHtml = `<div class="player-chip-list">`;
                    playersOnCell.forEach(player => {
                        const currentUserClass = (player.id === currentUserId) ? ' current-user' : '';
                        playerChipsHtml += `<span class="player-chip${currentUserClass}">${player.name}</span>`;
                    });
                    playerChipsHtml += `</div>`;
                }

                const cellHtml = `
                    <div class="board-cell" style="background-image: url('${cell.image_path}');">
                        <span class="cell-number-badge">${cellNumber}</span>
                        ${playerChipsHtml}
                    </div>
                `;
                gameBoard.append(cellHtml);
            });
        }


        // Theme toggle logic
        const themeToggleButton = document.getElementById('theme-toggle-icon-button');
        const iconMoon = document.getElementById('icon-moon');
        const iconSun = document.getElementById('icon-sun');

        function applyTheme(theme) {
            if (theme === 'dark') {
                document.body.classList.add('dark-theme');
                if (iconMoon) iconMoon.style.display = 'none';
                if (iconSun) iconSun.style.display = 'inline-block';
            } else {
                document.body.classList.remove('dark-theme');
                if (iconMoon) iconMoon.style.display = 'inline-block';
                if (iconSun) iconSun.style.display = 'none';
            }
        }

        let savedTheme = localStorage.getItem('theme');
        if (savedTheme) {
            applyTheme(savedTheme);
        } else {
            applyTheme('light');
        }

        if (themeToggleButton) {
            themeToggleButton.addEventListener('click', () => {
                let newTheme = document.body.classList.contains('dark-theme') ? 'light' : 'dark';
                localStorage.setItem('theme', newTheme);
                applyTheme(newTheme);
            });
        }

        const modalImageElement = document.getElementById('modalImage');
        if (modalImageElement) {
            modalImageElement.addEventListener('click', () => {
                $('#imageModal').modal('hide');
            });
        }

        // --- НОВОЕ: Обработчик отправки формы угадывания через AJAX ---
        function attachGuessFormListeners() {
            // Удаляем старые обработчики, чтобы избежать дублирования
            $('.guess-form').off('submit');

            $('.guess-form').on('submit', function(event) {
                event.preventDefault(); // Предотвращаем стандартную отправку формы

                const form = $(this);
                const cardId = form.data('card-id');
                const userCode = form.data('user-code');
                const guessedOwnerId = form.find('input[name="guessed_owner_id"]:checked').val();

                if (!guessedOwnerId) {
                    alert('Пожалуйста, выберите владельца карточки.');
                    return;
                }

                const url = `/user/${userCode}/guess/${cardId}`;
                const formData = {
                    guessed_owner_id: guessedOwnerId
                };

                $.ajax({
                    url: url,
                    type: 'POST',
                    data: formData,
                    success: function(response) {
                        if (response.status === 'success') {
                            // Сервер должен отправить 'game_update' после успешной обработки
                            // Поэтому нет необходимости вручную обновлять UI здесь,
                            // game_update сам перерисует все карточки.
                            console.log('Угадывание отправлено успешно.');
                            // Можно временно отключить форму, пока не придет game_update
                            form.find('button[type="submit"]').prop('disabled', true).text('Отправлено...');
                            form.find('input[type="radio"]').prop('disabled', true);

                        } else {
                            // Отобразить сообщение об ошибке, если есть
                            if (response.message) {
                                const gameMessages = $('#game-messages');
                                gameMessages.text(response.message).addClass('text-danger'); // Пример: показать ошибку
                                setTimeout(() => gameMessages.text('').removeClass('text-danger'), 5000);
                            }
                            console.error('Ошибка при отправке угадывания:', response.message);
                        }
                    },
                    error: function(xhr, status, error) {
                        const gameMessages = $('#game-messages');
                        gameMessages.text('Произошла ошибка при отправке угадывания. Попробуйте еще раз.').addClass('text-danger');
                        setTimeout(() => gameMessages.text('').removeClass('text-danger'), 5000);
                        console.error('AJAX Error:', status, error);
                    }
                });
            });
        }

        // Initial call to attach listeners when the page loads
        $(document).ready(function() {
            // Initial call to update page with existing data (if any, typically from server-side render)
            // Or wait for the first 'game_update' from socket.io
            // If you have initial data, you can call updatePage(initialGameState); here.
            attachGuessFormListeners(); // Ensure listeners are attached on initial load
        });
    </script>
</body>
</html>
