<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Страница игрока - {{ user_data_for_init.name if user_data_for_init else 'Игрок' }}</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        /* Примерные стили, можете их доработать или вынести в style.css */
        .game-board-cell {
            border: 1px solid #ccc;
            padding: 5px;
            margin: 2px;
            min-height: 80px; /* Минимальная высота для ячейки */
            background-size: cover;
            background-position: center;
            position: relative; /* Для позиционирования фишек игроков */
        }
        .player-chip {
            display: inline-block;
            background-color: rgba(0,0,255,0.7);
            color: white;
            padding: 2px 5px;
            border-radius: 3px;
            margin: 1px;
            font-size: 0.8em;
        }
        .user-hand .card, .table-cards .card {
            margin-bottom: 10px;
        }
        .pending-message {
            background-color: #fff3cd;
            border-color: #ffeeba;
            padding: .75rem 1.25rem;
            margin-bottom: 1rem;
            border: 1px solid transparent;
            border-radius: .25rem;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <h1 id="user-greeting">Добро пожаловать, {{ user_data_for_init.name if user_data_for_init else 'Игрок' }}!</h1>
        <p>Ваш код: <code id="user-code-display">{{ user_data_for_init.code if user_data_for_init else 'Не определен' }}</code></p>
        <p>Ваш рейтинг: <strong id="user-rating-display">{{ user_data_for_init.rating if user_data_for_init else 0 }}</strong></p>
        <p id="user-status-display">Статус: {{ user_data_for_init.status if user_data_for_init else 'Не определен' }}</p>

        <hr>

        <div id="game-messages" class="alert alert-info" role="alert" style="display: none;"></div>

        <div id="game-status-info">
            <p>Статус игры: <strong id="game-progress-status">Загрузка...</strong></p>
            <p>Текущая колода: <strong id="current-deck-display">Загрузка...</strong></p>
            <p>Ведущий: <strong id="current-leader-display">Загрузка...</strong></p>
            <p id="pending-player-message" class="pending-message" style="display: none;">
                Вы присоединились как наблюдатель. Ваше участие начнется со следующей НОВОЙ игры. Пока вы можете следить за процессом.
            </p>
        </div>
        <hr>

        <div id="player-hand-section" style="display: none;">
            <h2>Ваши карты:</h2>
            <div id="player-hand" class="row user-hand">
                </div>
        </div>

        <h2>Карты на столе (<span id="cards-on-table-count">0</span>/<span id="active-players-count">0</span>):</h2>
        <div id="table-cards" class="row table-cards">
            </div>
        <div id="table-placeholder" class="text-center" style="display: none;">
            <img id="leader-empty-table-pictogram" src="" alt="Место ведущего" style="max-width: 100px; display: none;">
            <p id="leader-empty-table-rating" style="display: none;"></p>
            <p>На столе пока нет карт. Если вы ведущий, выберите карту для выкладывания.</p>
        </div>
        <hr>

        <h2>Игровое поле:</h2>
        <div id="game-board" class="d-flex flex-wrap justify-content-center">
            </div>
        <hr>

        <p><a href="{{ url_for('index') }}" class="btn btn-secondary">Вернуться на главную</a></p>
        {% if session.get('is_admin') %}
            <p><a href="{{ url_for('admin') }}" class="btn btn-info">Перейти в Админ панель</a></p>
        {% endif %}
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.3/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>

    <script>
        // Определяем user_code из данных, переданных сервером при рендеринге,
        // или оставляем null, если пользователь не аутентифицирован (хотя на /user/<code> он должен быть).
        const currentUserCode = "{{ user_data_for_init.code if user_data_for_init else '' }}";
        let currentUserId = null; // Будет установлен из game_update
        let currentUserName = "{{ user_data_for_init.name if user_data_for_init else 'Игрок' }}";

        // Подключаемся к серверу Socket.IO.
        // Если ваше Flask-приложение и Socket.IO сервер на том же домене и порту,
        // io() без аргументов должно работать.
        // Иначе, укажите полный URL: const socket = io('http://yourdomain.com');
        const socket = io();

        socket.on('connect', () => {
            console.log('Socket.IO: Connected to server! SID:', socket.id);
            // Можно отправить серверу user_code, если он не был получен из сессии Flask на сервере
            // socket.emit('client_hello', { code: currentUserCode });
        });

        socket.on('disconnect', () => {
            console.log('Socket.IO: Disconnected from server.');
            const gameMessagesDiv = document.getElementById('game-messages');
            if (gameMessagesDiv) {
                gameMessagesDiv.textContent = 'Соединение с сервером потеряно. Попытка переподключения...';
                gameMessagesDiv.className = 'alert alert-danger';
                gameMessagesDiv.style.display = 'block';
            }
        });

        socket.on('message', (data) => { // Обработчик для простых сообщений от сервера (если будете использовать)
            console.log('Socket.IO: Message from server:', data);
            const gameMessagesDiv = document.getElementById('game-messages');
            if (gameMessagesDiv && data.data) {
                 gameMessagesDiv.textContent = data.data;
                 gameMessagesDiv.className = data.category ? `alert alert-${data.category}` : 'alert alert-info';
                 gameMessagesDiv.style.display = 'block';
            }
        });

        // Основной обработчик обновлений состояния игры
        socket.on('game_update', (gameState) => {
            console.log('Socket.IO: Received game_update:', gameState);

            // Обновляем данные текущего пользователя, если они пришли
            if (gameState.current_user_data) {
                currentUserId = gameState.current_user_data.id;
                currentUserName = gameState.current_user_data.name;
                document.getElementById('user-greeting').textContent = `Добро пожаловать, ${currentUserName}!`;
                document.getElementById('user-code-display').textContent = gameState.current_user_data.code;
                document.getElementById('user-rating-display').textContent = gameState.current_user_data.rating;
                document.getElementById('user-status-display').textContent = `Статус: ${gameState.current_user_data.status}`;

                const pendingPlayerMessage = document.getElementById('pending-player-message');
                if (gameState.current_user_data.status === 'pending') {
                    pendingPlayerMessage.style.display = 'block';
                    document.getElementById('player-hand-section').style.display = 'none'; // Скрыть секцию карт
                } else {
                    pendingPlayerMessage.style.display = 'none';
                    document.getElementById('player-hand-section').style.display = 'block'; // Показать секцию карт
                }
            } else if (currentUserCode) {
                 // Если gameState.current_user_data не пришел, но мы знаем код пользователя,
                 // возможно, это ошибка или пользователь еще не полностью идентифицирован на сервере.
                 // Пока оставляем данные, которые были при инициализации страницы.
            }


            // Обновляем отображение на странице, используя данные из gameState
            updateGameStatusInfo(gameState);
            updatePlayerHand(gameState.user_cards || [], gameState.active_subfolder, gameState.current_user_data ? gameState.current_user_data.status : null);
            updateTableCards(gameState.table_images || [], gameState.all_users_for_guessing || [], gameState.show_card_info, gameState.all_cards_placed_for_guessing_phase_to_template, gameState.db_current_leader_id, gameState.current_user_data ? gameState.current_user_data.id : null);
            updateGameBoard(gameState.game_board || [], gameState.current_num_board_cells);

            // Отображение сообщений игры, если они есть
            const gameMessagesDiv = document.getElementById('game-messages');
            if (gameState.flashed_messages && gameState.flashed_messages.length > 0) {
                // Пока простой вывод первого сообщения
                gameMessagesDiv.textContent = gameState.flashed_messages[0].message;
                gameMessagesDiv.className = `alert alert-${gameState.flashed_messages[0].category}`;
                gameMessagesDiv.style.display = 'block';
            } else if (gameMessagesDiv.textContent === 'Соединение с сервером потеряно. Попытка переподключения...') {
                // Если было сообщение о дисконнекте, но пришло обновление, значит, соединение восстановлено
                gameMessagesDiv.style.display = 'none';
            }
        });

        // --------------- Функции для рендеринга ---------------
        // (Эти функции будут созданы и наполнены на Шаге 2.4)

        function updateGameStatusInfo(gameState) {
            document.getElementById('game-progress-status').textContent = gameState.game_in_progress ? (gameState.game_over ? 'Игра окончена (подсчет/результаты)' : 'Идет игра') : 'Игра не начата / Ожидание';
            document.getElementById('current-deck-display').textContent = gameState.active_subfolder || 'Не выбрана';

            let leaderName = 'Не определен';
            if (gameState.db_current_leader_id && gameState.all_users_for_guessing) { // gameState.all_users_for_guessing это другие игроки
                // Ищем имя ведущего в общем списке (включая текущего, если он ведущий)
                const allPlayersForLeaderSearch = [...gameState.all_users_for_guessing];
                if (gameState.current_user_data) { // Добавляем текущего пользователя в список для поиска
                    allPlayersForLeaderSearch.push({id: gameState.current_user_data.id, name: gameState.current_user_data.name});
                }
                const leader = allPlayersForLeaderSearch.find(u => u.id === gameState.db_current_leader_id);
                if (leader) {
                    leaderName = leader.name;
                } else if (gameState.db_current_leader_id === (gameState.current_user_data ? gameState.current_user_data.id : null)) {
                    leaderName = gameState.current_user_data.name; // Если текущий пользователь - ведущий
                }
            }
            document.getElementById('current-leader-display').textContent = leaderName + (gameState.db_current_leader_id === (gameState.current_user_data ? gameState.current_user_data.id : null) && gameState.game_in_progress ? ' (Это вы!)' : '');

            document.getElementById('active-players-count').textContent = gameState.num_active_players || 0;
            document.getElementById('cards-on-table-count').textContent = gameState.num_cards_on_table || 0;
        }

        function updatePlayerHand(cards, activeSubfolder, currentUserStatus) {
            const playerHandDiv = document.getElementById('player-hand');
            const playerHandSectionDiv = document.getElementById('player-hand-section');
            playerHandDiv.innerHTML = ''; // Очищаем текущие карты

            if (currentUserStatus === 'pending' || !cards || cards.length === 0) {
                playerHandSectionDiv.style.display = 'none';
                if (currentUserStatus !== 'pending' && cards && cards.length === 0 && document.getElementById('game-progress-status').textContent.includes('Идет игра')) {
                     playerHandDiv.innerHTML = '<div class="col-12"><p>У вас нет карт на руках в этой колоде.</p></div>';
                     playerHandSectionDiv.style.display = 'block';
                }
                return;
            }
            playerHandSectionDiv.style.display = 'block';

            cards.forEach(card => {
                const cardDiv = document.createElement('div');
                cardDiv.className = 'col-md-3 col-sm-4 col-6'; // Адаптивная колонка
                cardDiv.innerHTML = `
                    <div class="card">
                        <img src="/static/images/${card.subfolder}/${card.image}" class="card-img-top" alt="Карта ${card.image}">
                        <div class="card-body text-center">
                            <form action="/user/${currentUserCode}/place/${card.id}" method="POST" class="place-card-form">
                                <button type="submit" class="btn btn-primary btn-sm">Выложить на стол</button>
                            </form>
                        </div>
                    </div>
                `;
                playerHandDiv.appendChild(cardDiv);
            });
        }

        function updateTableCards(tableImages, allUsersForGuessing, showCardInfo, allCardsPlaced, currentLeaderId, currentUserId) {
            const tableCardsDiv = document.getElementById('table-cards');
            const tablePlaceholderDiv = document.getElementById('table-placeholder');
            tableCardsDiv.innerHTML = ''; // Очищаем

            if (!tableImages || tableImages.length === 0) {
                tablePlaceholderDiv.style.display = 'block';
                tableCardsDiv.style.display = 'none';
                 // Логика для пиктограммы ведущего на пустом столе будет добавлена позже, если gameState.leader_pole_pictogram_path есть
                return;
            }
            tablePlaceholderDiv.style.display = 'none';
            tableCardsDiv.style.display = 'flex'; // Используем flex для выравнивания

            tableImages.forEach(card => {
                const cardDiv = document.createElement('div');
                cardDiv.className = 'col-md-3 col-sm-4 col-6';
                let cardContent = `
                    <div class="card">
                        <img src="/static/images/${card.subfolder}/${card.image}" class="card-img-top" alt="Карта ${card.image}">
                        <div class="card-body">
                `;

                if (showCardInfo) { // ЭТАП 3: Карты открыты админом
                    cardContent += `<h5 class="card-title">Владелец: ${card.owner_name || 'Неизвестен'}</h5>`;
                    // Отображение, кто как угадал эту карту
                    if (card.guesses && Object.keys(card.guesses).length > 0) {
                        cardContent += '<p class="card-text"><u>Предположения:</u></p><ul>';
                        for (const guesserIdStr in card.guesses) {
                            const guessedTargetId = card.guesses[guesserIdStr];
                            // Найти имя угадывающего
                            let guesserName = `Игрок ID ${guesserIdStr}`;
                            const guesserUser = allUsersForGuessing.find(u => u.id === parseInt(guesserIdStr)) || (currentUserId === parseInt(guesserIdStr) ? {name: currentUserName} : null) ;
                            if (guesserUser) guesserName = guesserUser.name;

                            // Найти имя того, на кого указали
                            let targetName = `Игрок ID ${guessedTargetId}`;
                            const targetUser = allUsersForGuessing.find(u => u.id === guessedTargetId) || (currentUserId === guessedTargetId ? {name: currentUserName} : null) || (card.owner_id === guessedTargetId ? {name: card.owner_name} : null);
                            if (targetUser) targetName = targetUser.name;
                            else if (card.owner_id === guessedTargetId) targetName = card.owner_name;


                            const isCorrect = guessedTargetId === card.owner_id;
                            cardContent += `<li>${guesserName} -> ${targetName} <span class="badge badge-${isCorrect ? 'success' : 'danger'}">${isCorrect ? 'Верно' : 'Мимо'}</span></li>`;
                        }
                        cardContent += '</ul>';
                    } else {
                        cardContent += '<p class="card-text">Предположений не было.</p>';
                    }
                } else if (allCardsPlaced) { // ЭТАП 2: Все карты выложены, идет угадывание
                    if (currentUserId && card.owner_id !== currentUserId) { // Нельзя угадывать свою карту
                        cardContent += `
                            <form action="/user/${currentUserCode}/guess/${card.id}" method="POST" class="guess-card-form">
                                <div class="form-group">
                                    <label for="guess-for-${card.id}">Чья это карта?</label>
                                    <select name="guessed_user_id" id="guess-for-${card.id}" class="form-control form-control-sm">
                                        <option value="">-- Выберите игрока --</option>`;
                        allUsersForGuessing.forEach(user => {
                            // Добавляем также владельца карты в список, если он есть среди активных, но не текущий пользователь
                            if(user.id !== currentUserId) { // Убеждаемся что не предлагаем угадать "себя" для своей карты (хотя это уже отфильтровано выше)
                                cardContent += `<option value="${user.id}" ${card.my_guess_for_this_card_value == user.id ? 'selected' : ''}>${user.name}</option>`;
                            }
                        });
                        // Добавить владельца карты в список для угадывания, если он не текущий юзер
                        if (card.owner_id && card.owner_id !== currentUserId && !allUsersForGuessing.find(u=>u.id === card.owner_id)) {
                             cardContent += `<option value="${card.owner_id}" ${card.my_guess_for_this_card_value == card.owner_id ? 'selected' : ''}>${card.owner_name || 'Владелец этой карты'}</option>`;
                        }

                        cardContent += `
                                    </select>
                                </div>
                                <button type="submit" class="btn btn-warning btn-sm">${card.my_guess_for_this_card_value ? 'Изменить голос' : 'Угадать'}</button>
                            </form>`;
                         if(card.my_guess_for_this_card_value) {
                            const guessedUserObj = allUsersForGuessing.find(u => u.id == card.my_guess_for_this_card_value) || (card.owner_id == card.my_guess_for_this_card_value ? {name: card.owner_name} : null) ;
                            const guessedName = guessedUserObj ? guessedUserObj.name : `ID ${card.my_guess_for_this_card_value}`;
                            cardContent += `<p class="mt-2 small">Ваш выбор: ${guessedName}</p>`;
                        }

                    } else if (card.owner_id === currentUserId) {
                        cardContent += '<p class="card-text text-muted">(Это ваша карта)</p>';
                    } else {
                         cardContent += '<p class="card-text text-muted">(Карта другого игрока, но вы не можете голосовать/вы наблюдатель)</p>';
                    }
                } else { // ЭТАП 1: Карты выкладываются, угадывать еще нельзя
                    cardContent += '<p class="card-text text-muted">(Ожидание карт от всех игроков)</p>';
                }

                cardContent += `
                        </div> </div> `;
                cardDiv.innerHTML = cardContent;
                tableCardsDiv.appendChild(cardDiv);
            });
        }

        function updateGameBoard(boardCells, totalCells) {
            const gameBoardDiv = document.getElementById('game-board');
            gameBoardDiv.innerHTML = ''; // Очищаем

            if (!boardCells || boardCells.length === 0) {
                gameBoardDiv.innerHTML = '<p>Игровое поле не загружено.</p>';
                return;
            }

            boardCells.forEach(cell => {
                const cellDiv = document.createElement('div');
                cellDiv.className = 'game-board-cell';
                // Устанавливаем относительный путь к картинке фона
                cellDiv.style.backgroundImage = `url(/static/${cell.image_path})`;
                cellDiv.style.width = `calc(${100 / Math.min(totalCells, 10)}% - 4px)`; // Пример: 10 ячеек в ряду
                cellDiv.title = `Ячейка ${cell.cell_number}`;

                let cellHtml = `<small class="cell-number">${cell.cell_number}</small>`;
                if (cell.users_in_cell && cell.users_in_cell.length > 0) {
                    cell.users_in_cell.forEach(user => {
                        cellHtml += `<span class="player-chip" title="${user.name} (Рейтинг: ${user.rating})">${user.name.substring(0,3)}</span>`;
                    });
                }
                cellDiv.innerHTML = cellHtml;
                gameBoardDiv.appendChild(cellDiv);
            });
        }

    </script>
</body>
</html>
